<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>data_analysis &mdash; iMSminer_beta 0.0.0 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
      <link rel="stylesheet" href="../_static/fonts.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            iMSminer_beta
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">iMSminer_beta</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">data_analysis</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for data_analysis</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">@author: Yu Tin Lin (yutinlin@stanford.edu)</span>
<span class="sd">@author: Haohui Bao (susanab20020911@gmail.com)</span>
<span class="sd">@author: Boone M. Prentice (booneprentice@ufl.chem.edu)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">matplotlib.gridspec</span> <span class="kn">import</span> <span class="n">GridSpec</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">ListedColormap</span><span class="p">,</span> <span class="n">Normalize</span>
<span class="kn">from</span> <span class="nn">sklearn.manifold</span> <span class="kn">import</span> <span class="n">TSNE</span>
<span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">PolynomialFeatures</span>
<span class="kn">from</span> <span class="nn">statannotations.Annotator</span> <span class="kn">import</span> <span class="n">Annotator</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">permutations</span><span class="p">,</span> <span class="n">combinations</span>
<span class="kn">from</span> <span class="nn">statsmodels.formula.api</span> <span class="kn">import</span> <span class="n">ols</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">import</span> <span class="nn">seaborn</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;/home/yutinlin/workspace/iMSminer&quot;</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">assorted_functions</span> <span class="kn">import</span> <span class="n">make_image_1c</span><span class="p">,</span> <span class="n">make_image_1c_njit</span><span class="p">,</span> <span class="n">max_normalize</span><span class="p">,</span> <span class="n">clustering_in_embedding</span><span class="p">,</span> <span class="n">plot_image_at_point</span><span class="p">,</span> <span class="n">gromov_trick</span><span class="p">,</span> <span class="n">significance</span><span class="p">,</span> <span class="n">draw_ROI</span>

<span class="c1"># DataAnalysis class</span>


<div class="viewcode-block" id="DataAnalysis"><a class="viewcode-back" href="../docs/data_analysis.html#data_analysis.DataAnalysis">[docs]</a><span class="k">class</span> <span class="nc">DataAnalysis</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Performs data analysis on preprocessed intensity matrix and coordinate arrays. Mass alignment function wasa refactored from the python module msalign (https://github.com/lukasz-migas/msalign)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data_dir : str, user input</span>
<span class="sd">            user-specified path points to directory containing preprocessed data</span>
<span class="sd">        fig_ratio : str, user input</span>
<span class="sd">            user-specified text:figure ratio for rendered figures from options `small`, `medium`, and `large`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">detect_gpu</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;nvidia-smi&#39;</span><span class="p">,</span> <span class="s1">&#39;--query-gpu=name&#39;</span><span class="p">,</span> <span class="s1">&#39;--format=csv&#39;</span><span class="p">],</span>
                                    <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">detect_gpu</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;GPU Detected:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">detect_gpu</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

            <span class="n">test_library</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cupy&#39;</span><span class="p">,</span> <span class="s1">&#39;cudf&#39;</span><span class="p">,</span> <span class="s1">&#39;cuml&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">lib</span> <span class="ow">in</span> <span class="n">test_library</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">__import__</span><span class="p">(</span><span class="n">lib</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">lib</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> is installed and imported successfully!&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">gpu</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">lib</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> is not installed or could not be imported.&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">gpu</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No GPU detected or NVIDIA driver not installed.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gpu</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="nb">__import__</span><span class="p">(</span><span class="s2">&quot;numba&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Numba is installed and imported successfully!&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jit</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Numba is not installed or could not be imported.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jit</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;What is your image dataset directory? &quot;</span><span class="p">)</span>

        <span class="n">fig_ratio_chosen</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">fig_ratio_chosen</span><span class="p">:</span>
            <span class="n">fig_ratio</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
                <span class="s2">&quot;Render figures with `small`, `medium`, or `large` ratio? &quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fig_ratio</span> <span class="o">==</span> <span class="s2">&quot;small&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span> <span class="o">=</span> <span class="mi">10</span>
                <span class="n">fig_ratio_chosen</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">fig_ratio</span> <span class="o">==</span> <span class="s2">&quot;medium&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span> <span class="o">=</span> <span class="mf">12.5</span>
                <span class="n">fig_ratio_chosen</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">fig_ratio</span> <span class="o">==</span> <span class="s2">&quot;large&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span> <span class="o">=</span> <span class="mi">15</span>
                <span class="n">fig_ratio_chosen</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig_ratio_chosen</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Select one of the options.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="DataAnalysis.load_preprocessed_data"><a class="viewcode-back" href="../docs/data_analysis.html#data_analysis.DataAnalysis.load_preprocessed_data">[docs]</a>    <span class="k">def</span> <span class="nf">load_preprocessed_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;import preprocessed intensity matrix and coordinate arrays, perform ROI annotation and selection, and store information for further data analysis</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ROI_num : int, user input</span>
<span class="sd">            user-specified number of ROIs for dataset</span>
<span class="sd">        ROIs : str, user input</span>
<span class="sd">            ROI annotations from left to right, top to bottom</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">datasets</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">)</span>
        <span class="n">datasets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">datasets</span><span class="p">)[(</span><span class="n">np</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
            <span class="n">datasets</span><span class="p">,</span> <span class="s2">&quot;coords&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="s2">&quot;csv&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)]</span>

        <span class="n">df_mean_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">ROI_edge</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">rep</span><span class="p">,</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">datasets</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Importing </span><span class="si">{</span><span class="n">dataset</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="n">df_build</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">dataset</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished importing </span><span class="si">{</span><span class="n">dataset</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

            <span class="n">df_build</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Unnamed: 0&#39;</span><span class="p">:</span> <span class="s1">&#39;mz&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df_build</span> <span class="o">=</span> <span class="n">df_build</span><span class="o">.</span><span class="n">T</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">mz</span> <span class="o">=</span> <span class="n">df_build</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;mz&#39;</span><span class="p">]</span>
            <span class="n">df_build</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;mz&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">df_coords</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">dataset</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="si">}</span><span class="s2">_coords.csv&quot;</span><span class="p">)</span>
            <span class="n">df_coords</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;0&#39;</span><span class="p">:</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span> <span class="s1">&#39;y&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df_coords</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_coords</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">df_coords</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">df_coords</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_coords</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">df_coords</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="n">df_build</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df_coords</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">df_build</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_build</span><span class="p">,</span> <span class="n">df_coords</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># img_array_1c = make_image_1c(data_2darray = pd.concat([pd.Series(np.ones(df_build.iloc[:,:].shape[0])),df_build.iloc[:,-2:]], axis=1).to_numpy())</span>
            <span class="n">img_array_1c</span> <span class="o">=</span> <span class="n">make_image_1c</span><span class="p">(</span><span class="n">data_2darray</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="n">df_build</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span> <span class="n">df_build</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">2</span><span class="p">:]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">img_array_1c</span> <span class="o">=</span> <span class="n">img_array_1c</span>

            <span class="c1"># [&quot;PC_10&quot;, &quot;PC_35&quot;, &quot;P6_10&quot;, &quot;P6_35&quot;, &quot;GF_10&quot;, &quot;GF_35&quot;, &quot;CMC_10&quot;, &quot;CMC_35&quot;]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ROI_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">&quot;How many ROIs are you analyzing? &quot;</span><span class="p">))</span>
            <span class="n">ROIs</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
                <span class="s2">&quot;How to name your ROIs, from left to right, top to bottom? Separate ROI names by one space.&quot;</span><span class="p">)</span>
            <span class="n">ROIs</span> <span class="o">=</span> <span class="n">ROIs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>

            <span class="n">ROI_exit</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">ROI_exit</span><span class="p">:</span>
                <span class="n">ROI_dim_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">ROI</span> <span class="ow">in</span> <span class="n">ROIs</span><span class="p">:</span>
                    <span class="c1"># ROI_dim = cv2.selectROI(&#39;ROI_selection&#39;, img_array_1c[0], showCrosshair=True)</span>
                    <span class="n">ROI_select</span> <span class="o">=</span> <span class="n">bbox_select</span><span class="p">(</span><span class="n">img_array_1c</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">ROI_select</span><span class="o">.</span><span class="n">disconnect_event</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
                    <span class="c1"># ROI_dim = np.asarray(ROI_select.selected_points)</span>
                    <span class="c1"># ROI_dim_array = np.append(ROI_dim_array, ROI_dim.reshape((1,-1)), axis=0)</span>
               <span class="c1"># cv2.destroyAllWindows()</span>
                <span class="n">ROI_sele</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Keep ROI selecction? (yes/no) &quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ROI_sele</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
                    <span class="n">ROI_exit</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ROI_exit</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="n">df_build</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;placeholder&#39;</span>
            <span class="n">df_build</span><span class="p">[</span><span class="s1">&#39;replicate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rep</span>
            <span class="c1"># df_build.drop(&quot;ROI&quot;, axis=1, inplace=True)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ROI</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ROIs</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Select ROI </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, labeled </span><span class="si">{</span><span class="n">ROI</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="n">bottom</span> <span class="o">=</span> <span class="n">ROI_dim_array</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">top</span> <span class="o">=</span> <span class="n">ROI_dim_array</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ROI_dim_array</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">left</span> <span class="o">=</span> <span class="n">ROI_dim_array</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">right</span> <span class="o">=</span> <span class="n">ROI_dim_array</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">ROI_dim_array</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

                <span class="n">ROI_xy</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_build</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">left</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_build</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">right</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
                    <span class="n">df_build</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">bottom</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_build</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">top</span><span class="p">)</span>
                <span class="n">df_build</span><span class="p">[</span><span class="s2">&quot;ROI&quot;</span><span class="p">][</span><span class="n">ROI_xy</span><span class="p">]</span> <span class="o">=</span> <span class="n">ROI</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ROI </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> is selected and labeled </span><span class="si">{</span><span class="n">ROI</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span>

                <span class="n">ROI_edge</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">ROI_edge</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">ROI</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">rep</span><span class="p">])],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="p">,</span> <span class="n">df_build</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">ROI_edge</span> <span class="o">=</span> <span class="n">ROI_edge</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ROI_edge</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ROI&quot;</span><span class="p">,</span> <span class="s2">&quot;bottom&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="s2">&quot;replicate&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_info</span> <span class="o">=</span> <span class="n">ROI_edge</span></div>

<div class="viewcode-block" id="DataAnalysis.calibrate_mz"><a class="viewcode-back" href="../docs/data_analysis.html#data_analysis.DataAnalysis.calibrate_mz">[docs]</a>    <span class="k">def</span> <span class="nf">calibrate_mz</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Interactive calibration using polynomial regression via linear model of user-specified degree</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        degree : int, user input</span>
<span class="sd">            user-specified degree for linear model used in polynomial regression calibration</span>
<span class="sd">        reference_mz : array of floats, user input</span>
<span class="sd">            user-specified reference massess to perform calibration on</span>
<span class="sd">        calibration_exit : str, user input</span>
<span class="sd">            exits calibration if user specifies `yes`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/calibration&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/calibration&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;classic&#39;</span><span class="p">)</span>

        <span class="n">exit_regression</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">exit_regression</span><span class="p">:</span>
            <span class="n">degree</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;What is the degree of linear model for calibration? Enter an integer. &quot;</span><span class="p">))</span>
            <span class="n">reference_mz</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;What are your reference m/z&#39;s? Separate each reference m/z by one space. &quot;</span><span class="p">)</span>
            <span class="n">reference_mz</span> <span class="o">=</span> <span class="n">reference_mz</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="n">reference_mz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">reference_mz</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">resid_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span>
                <span class="nb">abs</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">-</span> <span class="n">reference_mz</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:])),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">resid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="p">[</span><span class="n">resid_index</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">-</span> <span class="n">reference_mz</span>

            <span class="n">poly</span> <span class="o">=</span> <span class="n">PolynomialFeatures</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="n">degree</span><span class="p">,</span> <span class="n">include_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">poly_features_resid</span> <span class="o">=</span> <span class="n">poly</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="p">[</span><span class="n">resid_index</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">poly_reg_model</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
            <span class="n">poly_reg_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">poly_features_resid</span><span class="p">,</span> <span class="n">resid</span><span class="p">)</span>
            <span class="n">R2</span> <span class="o">=</span> <span class="n">poly_reg_model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">poly_features_resid</span><span class="p">,</span> <span class="n">resid</span><span class="p">)</span>

            <span class="n">poly_features</span> <span class="o">=</span> <span class="n">poly</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">resid_predicted</span> <span class="o">=</span> <span class="n">poly_reg_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">poly_features</span><span class="p">)</span>

            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
                <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span><span class="o">*</span><span class="mf">0.7</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="p">[</span><span class="n">resid_index</span><span class="p">],</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="p">[</span><span class="n">resid_index</span><span class="p">]</span> <span class="o">-</span> <span class="n">resid</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
            <span class="n">resid_index_compl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="n">resid_index_compl</span><span class="p">[</span><span class="n">resid_index</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="p">[</span><span class="n">resid_index_compl</span><span class="p">],</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="p">[</span><span class="n">resid_index_compl</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz</span> <span class="o">+</span> <span class="n">resid_predicted</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Linear model of degree </span><span class="si">{</span><span class="n">degree</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Experimental m/z&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Calibrated m/z&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;$R^2 = </span><span class="si">{</span><span class="n">R2</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                    <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

            <span class="n">calibration_exit</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Accept changes to calibration? (yes/no) &quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">calibration_exit</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mz</span> <span class="o">-=</span> <span class="n">resid_predicted</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/calibration/accepted_calibration_degree</span><span class="si">{</span><span class="n">degree</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
                <span class="n">exit_regression</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">calibration_exit</span> <span class="o">==</span> <span class="s2">&quot;no&quot;</span><span class="p">:</span>
                <span class="n">exit_regression</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">exit_regression</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span></div>

<div class="viewcode-block" id="DataAnalysis.MS1_search"><a class="viewcode-back" href="../docs/data_analysis.html#data_analysis.DataAnalysis.MS1_search">[docs]</a>    <span class="k">def</span> <span class="nf">MS1_search</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ppm_threshold</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;MS1 accurate mass search using </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ppm_threshold : int, optional</span>
<span class="sd">            ppm threshold for MS1 accurate mass hits, by default 5</span>
<span class="sd">        ion_type : str, user input</span>
<span class="sd">            ion types of MS1 hits</span>
<span class="sd">        mass_diff : float, user input</span>
<span class="sd">            mass differences of ion types from monoisotopic neutural</span>
<span class="sd">        MS1_db_path : str, user input</span>
<span class="sd">            local file path of MS1 database</span>
<span class="sd">        mz_col : int, user input</span>
<span class="sd">            number denoting column in database corresponding to exact mass of monoisotopic neutral </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ion_type</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
            <span class="s2">&quot;What are your ion types of interest? Separate each ion type by one space? &quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ion_type</span> <span class="o">=</span> <span class="n">ion_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="n">mass_diff</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
            <span class="s2">&quot;What is the corresponding mass difference of your ion type(s)? List ion types in same order as previously aand separate each ion type by one space. &quot;</span><span class="p">)</span>
        <span class="n">mass_diff</span> <span class="o">=</span> <span class="n">mass_diff</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mass_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mass_diff</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="n">MS1_db_path</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
            <span class="s2">&quot;What is the file path of MS1 database in csv format? &quot;</span><span class="p">)</span>
        <span class="n">mz_col</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span>
            <span class="s2">&quot;Which column in your MS1 database corresponds to neurtral monoisotopic masses? &quot;</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Importing MS1 database. . .&quot;</span><span class="p">)</span>
        <span class="n">MS1_db</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">MS1_db_path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finished importing MS1 database!&quot;</span><span class="p">)</span>

        <span class="n">MS1_db</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">MS1_db</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">mz_col</span><span class="p">]:</span> <span class="s1">&#39;exact_mass&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># zip(self.mass_diff, self.ion_type):</span>
        <span class="k">for</span> <span class="n">mz_diff</span><span class="p">,</span> <span class="n">adduct</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_diff</span><span class="p">,</span> <span class="n">ion_type</span><span class="p">):</span>
            <span class="n">MS1</span> <span class="o">=</span> <span class="n">MS1_db</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">MS1</span><span class="p">[</span><span class="s2">&quot;ion_mass&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MS1</span><span class="p">[</span><span class="s2">&quot;exact_mass&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">mz_diff</span>
            <span class="n">MS1</span><span class="p">[</span><span class="s2">&quot;ion_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adduct</span>

            <span class="n">MS1_ion_mass</span> <span class="o">=</span> <span class="n">MS1</span><span class="p">[</span><span class="s2">&quot;ion_mass&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="n">mz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">MS1_hits</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span>
                <span class="p">(</span><span class="n">mz</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">-</span> <span class="n">MS1_ion_mass</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:])</span> <span class="o">/</span> <span class="n">mz</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ppm_threshold</span><span class="p">)</span>
            <span class="n">MS1_hits</span> <span class="o">=</span> <span class="n">MS1_hits</span><span class="o">.</span><span class="n">stack</span><span class="p">()[</span><span class="n">MS1_hits</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>

            <span class="n">all_rows</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">MS1_hits</span><span class="p">):</span>
                <span class="n">combined_row</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">MS1</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">all_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">combined_row</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">ms1_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="n">all_rows</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[[</span><span class="s1">&#39;analyte&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">MS1</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()])</span></div>

<div class="viewcode-block" id="DataAnalysis.filter_analytes"><a class="viewcode-back" href="../docs/data_analysis.html#data_analysis.DataAnalysis.filter_analytes">[docs]</a>    <span class="k">def</span> <span class="nf">filter_analytes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;MS1&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Subset peak-picked untargeted data to analytes of interest</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        method : str, optional</span>
<span class="sd">            type of filtering, by default &quot;MS1&quot;</span>
<span class="sd">            method &quot;MS1&quot; subsets untargeted data to MS1 hits </span>
<span class="sd">            method &quot;analyte_class&quot; subsets untargeted data to specified analyte class(es) from MS1 hits</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;MS1&quot;</span><span class="p">:</span>
            <span class="n">truncate_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">columns</span> <span class="o">==</span> <span class="s2">&quot;x&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ms1_df</span><span class="p">[</span><span class="s1">&#39;analyte&#39;</span><span class="p">])],</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">truncate_col</span><span class="p">:]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">truncate_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">columns</span> <span class="o">==</span> <span class="s2">&quot;x&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">truncate_col</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                <span class="nb">str</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">truncate_col</span><span class="p">:])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ms1_df</span><span class="p">[</span><span class="s1">&#39;analyte&#39;</span><span class="p">])]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;analyte_class&quot;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Method not recognized. Please choose from options specified in documentation. &quot;</span><span class="p">)</span>
            <span class="k">pass</span></div>

<div class="viewcode-block" id="DataAnalysis.normalize_pixel"><a class="viewcode-back" href="../docs/data_analysis.html#data_analysis.DataAnalysis.normalize_pixel">[docs]</a>    <span class="k">def</span> <span class="nf">normalize_pixel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;TIC&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Normalize pixels using specified method</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        method : str, optional</span>
<span class="sd">            method to compute normalization factor, by default &quot;TIC&quot;</span>
<span class="sd">            method &quot;TIC&quot; normalizes on total ion count over each pixel</span>
<span class="sd">            method &quot;RMS&quot; normalizes on root mean square over each pixel</span>
<span class="sd">            method &quot;reference&quot; normalizes on a reference analyte specified by m/z or index</span>
<span class="sd">            meethod &quot;max&quot; normalizes on maximum intensity of each pixel</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Normalizing pixels with </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">truncate_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">columns</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;TIC&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">div</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;RMS&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;reference&quot;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">div</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Normalization method not found. Default to no normalization&quot;</span><span class="p">)</span>
            <span class="k">pass</span></div>

<div class="viewcode-block" id="DataAnalysis.get_ion_image"><a class="viewcode-back" href="../docs/data_analysis.html#data_analysis.DataAnalysis.get_ion_image">[docs]</a>    <span class="k">def</span> <span class="nf">get_ion_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">replicate</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">show_ROI</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_square</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">color_scheme</span><span class="o">=</span><span class="s2">&quot;inferno&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Render ion image for analytes in self._df_pixel_all (filtered or unfiltered)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        replicate : int, optional</span>
<span class="sd">            render image from specified replicate (dataset), by default 0</span>
<span class="sd">        show_ROI : bool, optional</span>
<span class="sd">            display specified label in redenred ion image, by default True</span>
<span class="sd">        show_square : bool, optional</span>
<span class="sd">            display selected ROI in green box in rendered ion image, by default False</span>
<span class="sd">        color_scheme : str, optional</span>
<span class="sd">            color scheme of ion image, by default &quot;inferno&quot;. A list of color schemes are available here: https://matplotlib.org/stable/users/explain/colors/colormaps.html</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/ion_image&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/ion_image&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;classic&#39;</span><span class="p">)</span>

        <span class="n">truncate_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">columns</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span> <span class="o">-</span>
                               <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">insitu_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="p">[</span><span class="s1">&#39;replicate&#39;</span><span class="p">],</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]],</span>
                              <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">insitu_df</span> <span class="o">=</span> <span class="n">insitu_df</span><span class="p">[</span><span class="n">insitu_df</span><span class="p">[</span><span class="s1">&#39;replicate&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">replicate</span><span class="p">]</span>
        <span class="n">insitu_df</span> <span class="o">=</span> <span class="n">insitu_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;replicate&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jit</span><span class="p">:</span>
            <span class="n">insitu_2darray</span> <span class="o">=</span> <span class="n">insitu_df</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="n">img_array_1c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">insitu_2darray</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">insitu_2darray</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]))</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                                     <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">insitu_2darray</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]))</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">insitu_image</span> <span class="o">=</span> <span class="n">make_image_1c_njit</span><span class="p">(</span>
                <span class="n">data_2darray</span><span class="o">=</span><span class="n">insitu_2darray</span><span class="p">,</span> <span class="n">img_array_1c</span><span class="o">=</span><span class="n">img_array_1c</span><span class="p">,</span> <span class="n">remap_coord</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">insitu_2darray</span><span class="p">,</span> <span class="n">img_array_1c</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">insitu_image</span> <span class="o">=</span> <span class="n">make_image_1c</span><span class="p">(</span>
                <span class="n">data_2darray</span><span class="o">=</span><span class="n">insitu_df</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">remap_coord</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">ROI_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ROI_info</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ROI_info</span><span class="p">[</span><span class="s2">&quot;replicate&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">replicate</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">analyte</span><span class="p">,</span> <span class="n">im</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">insitu_image</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;dark_background&#39;</span><span class="p">)</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">insitu_df</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">/</span><span class="mi">10</span><span class="p">})</span>
            <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
                <span class="c1"># image and legend grids</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">/</span><span class="mi">25</span><span class="p">],</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
            <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">im_plot</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">color_scheme</span><span class="p">)</span>
            <span class="n">draw_ROI</span><span class="p">(</span><span class="n">ROI_info</span><span class="p">,</span> <span class="n">show_ROI</span><span class="o">=</span><span class="n">show_ROI</span><span class="p">,</span>
                     <span class="n">show_square</span><span class="o">=</span><span class="n">show_square</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;m/z </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="p">[</span><span class="n">analyte</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">colorbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im_plot</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
            <span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">im</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">colorbar</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">([</span><span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span><span class="p">])</span>
            <span class="n">colorbar</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/ion_image/mz_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="p">[</span><span class="n">analyte</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">_replicate</span><span class="si">{</span><span class="n">replicate</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span></div>

<div class="viewcode-block" id="DataAnalysis.make_FC_plot"><a class="viewcode-back" href="../docs/data_analysis.html#data_analysis.DataAnalysis.make_FC_plot">[docs]</a>    <span class="k">def</span> <span class="nf">make_FC_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pthreshold</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">FCthreshold</span><span class="o">=</span><span class="mf">1.5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate volcano plots of ROI pairs, showing fold-change statistics and p-values </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pthreshold : float, optional</span>
<span class="sd">            p-value threshold for significant alterations in volcano plot, by default 0.05</span>
<span class="sd">        FCthreshold : float, optional</span>
<span class="sd">            fold-change threshold (positive) for dysregulation in volcano plot, by default 1.5</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/volcano&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/volcano&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/volcano_unlabeled&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/volcano_unlabeled&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;classic&#39;</span><span class="p">)</span>

        <span class="c1"># prepare dataframe for p-value and FC computations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_mean_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">,</span> <span class="s1">&#39;replicate&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_mean_all</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_mean_all</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_mean_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_mean_all</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df_mean_all</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">]</span>
                                            <span class="o">!=</span> <span class="s1">&#39;placeholder&#39;</span><span class="p">]</span>
        <span class="n">df_mean_all_long</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_mean_all</span><span class="p">,</span> <span class="n">id_vars</span><span class="o">=</span><span class="p">[</span>
                                   <span class="s1">&#39;ROI&#39;</span><span class="p">,</span> <span class="s1">&#39;replicate&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;analyte&#39;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;intensity&#39;</span><span class="p">)</span>

        <span class="n">df_FC</span> <span class="o">=</span> <span class="n">df_mean_all_long</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">,</span> <span class="s1">&#39;analyte&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting to generate volcano plots.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">combo</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">permutations</span><span class="p">(</span><span class="n">df_FC</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)):</span>
            <span class="n">df_FC_pair</span> <span class="o">=</span> <span class="n">df_FC</span><span class="p">[(</span><span class="n">df_FC</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">combo</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">|</span>
                               <span class="p">(</span><span class="n">df_FC</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">combo</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>

            <span class="n">reference_intensity</span> <span class="o">=</span> <span class="n">df_FC_pair</span><span class="p">[</span><span class="n">df_FC_pair</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">combo</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;analyte&#39;</span><span class="p">)[</span>
                <span class="s1">&#39;intensity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">df_FC_pair</span> <span class="o">=</span> <span class="n">df_FC_pair</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">reference_intensity</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;analyte&#39;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_ref&#39;</span><span class="p">))</span>
            <span class="n">df_FC_pair</span> <span class="o">=</span> <span class="n">df_FC_pair</span><span class="p">[(</span>
                <span class="n">df_FC_pair</span><span class="p">[[</span><span class="s1">&#39;intensity_ref&#39;</span><span class="p">]]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
            <span class="n">df_FC_pair</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">df_FC_pair</span><span class="p">[</span><span class="s1">&#39;intensity_ref&#39;</span><span class="p">]</span>

            <span class="n">df_FC_pair</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">df_FC_pair</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">])</span>

            <span class="n">df_FC_pair</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="c1"># compute p-value for each analyte</span>
            <span class="k">for</span> <span class="n">analyte_sele</span> <span class="ow">in</span> <span class="n">df_FC_pair</span><span class="p">[</span><span class="s1">&#39;analyte&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                <span class="n">df_analyte</span> <span class="o">=</span> <span class="n">df_mean_all_long</span><span class="p">[</span><span class="n">df_mean_all_long</span><span class="p">[</span><span class="s1">&#39;analyte&#39;</span><span class="p">]</span>
                                              <span class="o">==</span> <span class="n">analyte_sele</span><span class="p">]</span>
                <span class="n">lm_df</span> <span class="o">=</span> <span class="n">ols</span><span class="p">(</span><span class="s1">&#39;intensity ~ C(ROI)&#39;</span><span class="p">,</span>
                            <span class="n">data</span><span class="o">=</span><span class="n">df_analyte</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
                <span class="n">anova_df</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">anova_lm</span><span class="p">(</span><span class="n">lm_df</span><span class="p">,</span> <span class="n">typ</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="n">df_FC_pair</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_FC_pair</span><span class="p">[</span><span class="s1">&#39;analyte&#39;</span><span class="p">]</span> <span class="o">==</span>
                               <span class="n">analyte_sele</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">anova_df</span><span class="p">[</span><span class="s1">&#39;PR(&gt;F)&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">df_FC_pair</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">df_FC_pair</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">])</span>

            <span class="n">df_FC_pair</span><span class="p">[</span><span class="s1">&#39;condition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>
            <span class="n">df_FC_pair</span><span class="p">[</span><span class="s1">&#39;condition&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df_FC_pair</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">pthreshold</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span>
                <span class="n">df_FC_pair</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">FCthreshold</span><span class="p">))]</span> <span class="o">=</span> <span class="s2">&quot;down&quot;</span>
            <span class="n">df_FC_pair</span><span class="p">[</span><span class="s1">&#39;condition&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df_FC_pair</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">pthreshold</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span>
                <span class="n">df_FC_pair</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">FCthreshold</span><span class="p">))]</span> <span class="o">=</span> <span class="s2">&quot;up&quot;</span>

            <span class="n">palette</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;none&quot;</span><span class="p">:</span> <span class="s2">&quot;grey&quot;</span><span class="p">,</span>   <span class="c1"># Grey for non-significant points</span>
                        <span class="s2">&quot;down&quot;</span><span class="p">:</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span>   <span class="c1"># Blue for downregulated</span>
                        <span class="s2">&quot;up&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span>       <span class="c1"># Red for upregulated</span>
            <span class="p">}</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span><span class="o">*</span><span class="mf">1.5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span><span class="o">*</span><span class="mf">1.5</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span><span class="o">*</span><span class="mf">1.5</span><span class="p">})</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_FC_pair</span><span class="p">[</span><span class="n">df_FC_pair</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">combo</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                            <span class="n">x</span><span class="o">=</span><span class="s2">&quot;intensity&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;condition&quot;</span><span class="p">,</span>
                            <span class="n">palette</span><span class="o">=</span><span class="n">palette</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">combo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> / </span><span class="si">{</span><span class="n">combo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Log2 FC&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;-Log10 p_value&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">FCthreshold</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                        <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">FCthreshold</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                        <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">pthreshold</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                        <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_FC_pair</span><span class="p">[</span><span class="n">df_FC_pair</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">combo</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">pthreshold</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">FCthreshold</span><span class="p">)</span> <span class="ow">or</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">FCthreshold</span><span class="p">)):</span>
                    <span class="n">plot_mz</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;analyte&#39;</span><span class="p">])]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">],</span> <span class="n">plot_mz</span><span class="p">,</span>
                             <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;semibold&#39;</span><span class="p">,</span>
                             <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/volcano/</span><span class="si">{</span><span class="n">combo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">combo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

            <span class="c1"># vocalno unlabeled</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span><span class="o">*</span><span class="mf">1.5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span><span class="o">*</span><span class="mf">1.5</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span><span class="o">*</span><span class="mf">1.5</span><span class="p">})</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_FC_pair</span><span class="p">[</span><span class="n">df_FC_pair</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">combo</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                            <span class="n">x</span><span class="o">=</span><span class="s2">&quot;intensity&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;condition&quot;</span><span class="p">,</span>
                            <span class="n">palette</span><span class="o">=</span><span class="n">palette</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">combo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> / </span><span class="si">{</span><span class="n">combo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Log2 FC&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;-Log10 p_value&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">FCthreshold</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                        <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">FCthreshold</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                        <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">pthreshold</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                        <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/volcano_unlabeled/</span><span class="si">{</span><span class="n">combo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">combo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished generating volcano plots. </span><span class="se">\n\n</span><span class="s2"> Volcano plots were stroed in folder </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures.&quot;</span><span class="p">)</span></div>

        <span class="c1"># # ===heatmap===#</span>
        <span class="c1"># plt.figure(figsize=(len(list(permutations(</span>
        <span class="c1">#     df_FC[&#39;ROI&#39;].unique(), 2)))*3, len(df_FC[&#39;analyte&#39;].unique())/1.5))</span>
        <span class="c1"># plt.rcParams.update({&#39;font.size&#39;: len(df_FC[&#39;analyte&#39;].unique())/2.5})</span>
        <span class="c1"># df_hm = df_FC.pivot(index=&quot;analyte&quot;, columns=&quot;ROI&quot;, values=&quot;intensity&quot;)</span>
        <span class="c1"># df_hm = np.log2(df_hm.div(df_hm.mean(axis=1), axis=0))</span>
        <span class="c1"># sns.heatmap(df_hm, annot=True, fmt=&quot;.1f&quot;, vmin=-3, vmax=3,</span>
        <span class="c1">#             cbar_kws={&quot;shrink&quot;: 0.5, &quot;label&quot;: &quot;log2 FC&quot;})</span>
        <span class="c1"># plt.tight_layout()</span>
        <span class="c1"># plt.savefig(f&quot;{self.data_dir}/figures/volcano/heatmap&quot;, dpi=100)</span>
        <span class="c1"># plt.close()</span>

<div class="viewcode-block" id="DataAnalysis.insitu_clustering"><a class="viewcode-back" href="../docs/data_analysis.html#data_analysis.DataAnalysis.insitu_clustering">[docs]</a>    <span class="k">def</span> <span class="nf">insitu_clustering</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">perplexity</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">replicate</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">show_ROI</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_square</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/insitu_cluster&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/insitu_cluster&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;classic&#39;</span><span class="p">)</span>

        <span class="c1"># KMeans</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perplexity</span> <span class="o">=</span> <span class="n">perplexity</span>

        <span class="n">truncate_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">columns</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">)</span>
        <span class="n">df_pixel_all_max_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df_pixel_all_max_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_pixel_all_max_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">div</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">df_pixel_all_max_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpu</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Spatial segmentation on CPU. Computing time may be long.&quot;</span><span class="p">)</span>
            <span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span>
            <span class="kn">from</span> <span class="nn">sklearn.manifold</span> <span class="kn">import</span> <span class="n">TSNE</span>
            <span class="n">k_means</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="s2">&quot;k-means++&quot;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                             <span class="n">n_init</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_pixel_all_max_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">])</span>
            <span class="n">kmeans_labels</span> <span class="o">=</span> <span class="n">k_means</span><span class="o">.</span><span class="n">labels_</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="c1"># tSNE</span>
            <span class="n">num_iters</span> <span class="o">=</span> <span class="mi">1000</span>
            <span class="n">my_random_state</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">tsne</span> <span class="o">=</span> <span class="n">TSNE</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="n">num_iters</span><span class="p">,</span>
                        <span class="n">perplexity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">perplexity</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">my_random_state</span><span class="p">)</span>
            <span class="n">tsne_embedding</span> <span class="o">=</span> <span class="n">tsne</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span>
                <span class="n">df_pixel_all_max_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">])</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpu</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Spatial segmentation on GPU.&quot;</span><span class="p">)</span>
                <span class="kn">from</span> <span class="nn">cuml.manifold</span> <span class="kn">import</span> <span class="n">TSNE</span>
                <span class="kn">from</span> <span class="nn">cuml.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span>
                <span class="kn">from</span> <span class="nn">cuml</span> <span class="kn">import</span> <span class="n">using_output_type</span>

                <span class="k">with</span> <span class="n">using_output_type</span><span class="p">(</span><span class="s1">&#39;numpy&#39;</span><span class="p">):</span>
                    <span class="c1"># kmeans</span>
                    <span class="n">k_means</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
                        <span class="n">df_pixel_all_max_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">])</span>
                    <span class="n">kmeans_labels</span> <span class="o">=</span> <span class="n">k_means</span><span class="o">.</span><span class="n">labels_</span> <span class="o">+</span> <span class="mi">1</span>

                    <span class="c1"># tsne</span>
                    <span class="n">num_iters</span> <span class="o">=</span> <span class="mi">1000</span>
                    <span class="n">my_random_state</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">tsne</span> <span class="o">=</span> <span class="n">TSNE</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="n">num_iters</span><span class="p">,</span>
                                <span class="n">perplexity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">perplexity</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">my_random_state</span><span class="p">,</span>
                                <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
                    <span class="n">tsne_embedding</span> <span class="o">=</span> <span class="n">tsne</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span>
                        <span class="n">df_pixel_all_max_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;GPU error. Defaulting to CPU.&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Spatial segmentation on CPU. Computing time may be long.&quot;</span><span class="p">)</span>
                <span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span>
                <span class="kn">from</span> <span class="nn">sklearn.manifold</span> <span class="kn">import</span> <span class="n">TSNE</span>
                <span class="n">k_means</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="s2">&quot;k-means++&quot;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                 <span class="n">n_init</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_pixel_all_max_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">])</span>
                <span class="n">kmeans_labels</span> <span class="o">=</span> <span class="n">k_means</span><span class="o">.</span><span class="n">labels_</span> <span class="o">+</span> <span class="mi">1</span>

                <span class="c1"># tSNE</span>
                <span class="n">num_iters</span> <span class="o">=</span> <span class="mi">1000</span>
                <span class="n">my_random_state</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">tsne</span> <span class="o">=</span> <span class="n">TSNE</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="n">num_iters</span><span class="p">,</span>
                            <span class="n">perplexity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">perplexity</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">my_random_state</span><span class="p">)</span>
                <span class="n">tsne_embedding</span> <span class="o">=</span> <span class="n">tsne</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span>
                    <span class="n">df_pixel_all_max_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">])</span>

        <span class="n">df_pixel_all_max_all</span><span class="p">[</span><span class="s1">&#39;insitu_cluster&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">kmeans_labels</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span><span class="o">*</span><span class="mf">1.5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span><span class="o">*</span><span class="mf">1.5</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span><span class="o">*</span><span class="mf">1.5</span><span class="p">})</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;rainbow&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">kmeans_labels</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">kmeans_labels</span><span class="p">)):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">tsne_embedding</span><span class="p">[</span><span class="n">kmeans_labels</span> <span class="o">==</span> <span class="n">label</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">tsne_embedding</span><span class="p">[</span><span class="n">kmeans_labels</span> <span class="o">==</span> <span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                        <span class="n">c</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>  <span class="c1"># Normalize color within the colormap range</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Cluster </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;k-Means Clusters of Global Molecular Profile in t-SNE Embedding&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;t-SNE 1&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;t-SNE 2&quot;</span><span class="p">)</span>
        <span class="n">legend</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Cluster&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">legend_handle</span> <span class="ow">in</span> <span class="n">legend</span><span class="o">.</span><span class="n">legendHandles</span><span class="p">:</span>  <span class="c1"># reset legend alpha</span>
            <span class="n">legend_handle</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/insitu_cluster/kmeans_tsne&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

        <span class="n">categories</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">df_pixel_all_max_all</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">])</span>
        <span class="n">unique_categories</span> <span class="o">=</span> <span class="n">categories</span><span class="o">.</span><span class="n">categories</span>
        <span class="c1"># Get a colormap with as many colors as there are categories</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;rainbow&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_categories</span><span class="p">))</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span><span class="o">*</span><span class="mf">1.5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span><span class="o">*</span><span class="mf">1.5</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span><span class="o">*</span><span class="mf">1.5</span><span class="p">})</span>
        <span class="c1"># Plot each category separately to set up legends correctly</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">category</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_categories</span><span class="p">[</span><span class="n">unique_categories</span> <span class="o">!=</span> <span class="s2">&quot;placeholder&quot;</span><span class="p">]):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">df_pixel_all_max_all</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">category</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">tsne_embedding</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">tsne_embedding</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                        <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">category</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Global Molecular Profile in t-SNE Embedding&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;t-SNE 1&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;t-SNE 2&quot;</span><span class="p">)</span>

        <span class="c1"># Adding the legend</span>
        <span class="n">legend</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;ROI&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">legend_handle</span> <span class="ow">in</span> <span class="n">legend</span><span class="o">.</span><span class="n">legendHandles</span><span class="p">:</span>  <span class="c1"># reset legend alpha</span>
            <span class="n">legend_handle</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/insitu_cluster/original_space_tsne&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

        <span class="c1"># ===========IN SITU============#</span>
        <span class="n">insitu_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_pixel_all_max_all</span><span class="p">[</span><span class="s1">&#39;replicate&#39;</span><span class="p">],</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">kmeans_labels</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;kmeans_label&quot;</span><span class="p">]),</span>
                               <span class="n">df_pixel_all_max_all</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">insitu_df</span> <span class="o">=</span> <span class="n">insitu_df</span><span class="p">[</span><span class="n">insitu_df</span><span class="p">[</span><span class="s1">&#39;replicate&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">replicate</span><span class="p">]</span>
        <span class="n">insitu_df</span> <span class="o">=</span> <span class="n">insitu_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;replicate&#39;</span><span class="p">])</span>

        <span class="n">insitu_image</span> <span class="o">=</span> <span class="n">make_image_1c</span><span class="p">(</span>
            <span class="n">data_2darray</span><span class="o">=</span><span class="n">insitu_df</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">remap_coord</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">insitu_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_equal</span><span class="p">(</span><span class="n">insitu_image</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">ROI_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ROI_info</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ROI_info</span><span class="p">[</span><span class="s2">&quot;replicate&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">replicate</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;dark_background&#39;</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">insitu_df</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
            <span class="n">df_pixel_all_max_all</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">/</span><span class="mi">10</span><span class="p">})</span>
        <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">df_pixel_all_max_all</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
            <span class="c1"># image and legend grids</span>
            <span class="n">df_pixel_all_max_all</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">/</span><span class="mi">25</span><span class="p">],</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
        <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">kmeans_insitu</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">insitu_image</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;rainbow&quot;</span><span class="p">)</span>
        <span class="n">draw_ROI</span><span class="p">(</span><span class="n">ROI_info</span><span class="p">,</span> <span class="n">show_ROI</span><span class="o">=</span><span class="n">show_ROI</span><span class="p">,</span>
                 <span class="n">show_square</span><span class="o">=</span><span class="n">show_square</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">colorbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">kmeans_insitu</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
        <span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">insitu_image</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">insitu_image</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">colorbar</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">min_val</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_val</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/insitu_cluster/kmeans_insitu_image&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span></div>

<div class="viewcode-block" id="DataAnalysis.image_clustering"><a class="viewcode-back" href="../docs/data_analysis.html#data_analysis.DataAnalysis.image_clustering">[docs]</a>    <span class="k">def</span> <span class="nf">image_clustering</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">perplexity</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">replicate</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">show_ROI</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_square</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color_scheme</span><span class="o">=</span><span class="s2">&quot;inferno&quot;</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">quantile</span><span class="o">=</span><span class="mi">99</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/image_cluster&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/image_cluster&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;classic&#39;</span><span class="p">)</span>

        <span class="c1"># KMeans</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perplexity</span> <span class="o">=</span> <span class="n">perplexity</span>

        <span class="n">truncate_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">columns</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">)</span>
        <span class="n">df_pixel_all_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">div</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpu</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Image clustering on CPU. Computing time may be long.&quot;</span><span class="p">)</span>
            <span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span>
            <span class="kn">from</span> <span class="nn">sklearn.manifold</span> <span class="kn">import</span> <span class="n">TSNE</span>

            <span class="n">k_means</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="s2">&quot;k-means++&quot;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                             <span class="n">n_init</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">kmeans_labels</span> <span class="o">=</span> <span class="n">k_means</span><span class="o">.</span><span class="n">labels_</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="c1"># tSNE</span>
            <span class="n">num_iters</span> <span class="o">=</span> <span class="mi">1000</span>
            <span class="n">my_random_state</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">tsne</span> <span class="o">=</span> <span class="n">TSNE</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="n">num_iters</span><span class="p">,</span>
                        <span class="n">perplexity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">perplexity</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">my_random_state</span><span class="p">)</span>
            <span class="n">tsne_embedding</span> <span class="o">=</span> <span class="n">tsne</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span>
                <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpu</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Image clustering on GPU.&quot;</span><span class="p">)</span>
                <span class="kn">from</span> <span class="nn">cuml.manifold</span> <span class="kn">import</span> <span class="n">TSNE</span>
                <span class="kn">from</span> <span class="nn">cuml.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span>
                <span class="kn">from</span> <span class="nn">cuml</span> <span class="kn">import</span> <span class="n">using_output_type</span>

                <span class="k">with</span> <span class="n">using_output_type</span><span class="p">(</span><span class="s1">&#39;numpy&#39;</span><span class="p">):</span>

                    <span class="n">k_means</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
                        <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                    <span class="n">kmeans_labels</span> <span class="o">=</span> <span class="n">k_means</span><span class="o">.</span><span class="n">labels_</span> <span class="o">+</span> <span class="mi">1</span>

                    <span class="c1"># tsne</span>
                    <span class="n">num_iters</span> <span class="o">=</span> <span class="mi">1000</span>
                    <span class="n">my_random_state</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">tsne</span> <span class="o">=</span> <span class="n">TSNE</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="n">num_iters</span><span class="p">,</span>
                                <span class="n">perplexity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">perplexity</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">my_random_state</span><span class="p">,</span>
                                <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
                    <span class="n">tsne_embedding</span> <span class="o">=</span> <span class="n">tsne</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span>
                        <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;GPU error. Defaulting to CPU.&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Image clustering on CPU. Computing time may be long.&quot;</span><span class="p">)</span>
                <span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span>
                <span class="kn">from</span> <span class="nn">sklearn.manifold</span> <span class="kn">import</span> <span class="n">TSNE</span>

                <span class="n">k_means</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="s2">&quot;k-means++&quot;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                 <span class="n">n_init</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                <span class="n">kmeans_labels</span> <span class="o">=</span> <span class="n">k_means</span><span class="o">.</span><span class="n">labels_</span> <span class="o">+</span> <span class="mi">1</span>

                <span class="c1"># tSNE</span>
                <span class="n">num_iters</span> <span class="o">=</span> <span class="mi">1000</span>
                <span class="n">my_random_state</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">tsne</span> <span class="o">=</span> <span class="n">TSNE</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="n">num_iters</span><span class="p">,</span>
                            <span class="n">perplexity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">perplexity</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">my_random_state</span><span class="p">)</span>
                <span class="n">tsne_embedding</span> <span class="o">=</span> <span class="n">tsne</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span>
                    <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="n">image_cluster_label</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">kmeans_labels</span><span class="p">)</span>
        <span class="n">image_cluster_label</span> <span class="o">=</span> <span class="n">image_cluster_label</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">image_cluster_label</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="s1">&#39;analyte&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;cluster&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">image_df</span> <span class="o">=</span> <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">,</span> <span class="s1">&#39;replicate&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">cluster_mean_df</span> <span class="o">=</span> <span class="n">image_df</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">]</span>
        <span class="n">image_cluster_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">cluster_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>  <span class="c1"># loop through clusters</span>
            <span class="n">cluster_df</span> <span class="o">=</span> <span class="n">image_df</span><span class="p">[</span><span class="n">image_cluster_label</span><span class="p">[</span><span class="n">image_cluster_label</span><span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">]</span>
                                                      <span class="o">==</span> <span class="n">cluster_index</span><span class="p">][</span><span class="s1">&#39;analyte&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">cluster_df</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cluster_index</span><span class="p">)</span>
            <span class="n">cluster_mean_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">cluster_mean_df</span><span class="p">,</span> <span class="n">cluster_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">image_cluster</span> <span class="o">=</span> <span class="n">df_pixel_all_max</span><span class="p">[</span><span class="n">image_cluster_label</span><span class="p">[</span><span class="n">image_cluster_label</span><span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">]</span>
                                                                 <span class="o">==</span> <span class="n">cluster_index</span><span class="p">][</span><span class="s1">&#39;analyte&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">image_cluster</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cluster_index</span><span class="p">)</span>
            <span class="n">image_cluster_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                <span class="p">[</span><span class="n">image_cluster_all</span><span class="p">,</span> <span class="n">image_cluster</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">cluster_mean_df</span> <span class="o">=</span> <span class="n">cluster_mean_df</span><span class="p">[</span><span class="n">cluster_mean_df</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">]</span>
                                          <span class="o">!=</span> <span class="s2">&quot;placeholder&quot;</span><span class="p">]</span>

        <span class="n">image_cluster_all</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]]</span>
        <span class="n">image_cluster_all</span> <span class="o">=</span> <span class="n">image_cluster_all</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="p">[</span><span class="s1">&#39;replicate&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">replicate</span><span class="p">]</span>
        <span class="n">image_cluster_all</span> <span class="o">=</span> <span class="n">image_cluster_all</span><span class="p">[</span><span class="n">image_cluster_all</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">]</span>
                                              <span class="o">!=</span> <span class="s2">&quot;placeholder&quot;</span><span class="p">]</span>

        <span class="c1"># kmeans image clusters in t-SNE embedding</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span><span class="o">*</span><span class="mf">1.5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span><span class="o">*</span><span class="mf">1.5</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span><span class="o">*</span><span class="mf">1.5</span><span class="p">})</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;rainbow&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">kmeans_labels</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">kmeans_labels</span><span class="p">)):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">tsne_embedding</span><span class="p">[</span><span class="n">kmeans_labels</span> <span class="o">==</span> <span class="n">label</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">tsne_embedding</span><span class="p">[</span><span class="n">kmeans_labels</span> <span class="o">==</span> <span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                        <span class="n">c</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>  <span class="c1"># Normalize color within the colormap range</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Cluster </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;k-Means Clusters of Global Molecular Profile in t-SNE Embedding&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;t-SNE 1&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;t-SNE 2&quot;</span><span class="p">)</span>
        <span class="n">legend</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Cluster&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">legend_handle</span> <span class="ow">in</span> <span class="n">legend</span><span class="o">.</span><span class="n">legendHandles</span><span class="p">:</span>  <span class="c1"># reset legend alpha</span>
            <span class="n">legend_handle</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/image_cluster/image_kmeans_tsne&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

        <span class="c1"># insitu images in t-SNE embedding</span>
        <span class="n">truncate_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">columns</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="n">insitu_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="p">[</span><span class="s1">&#39;replicate&#39;</span><span class="p">],</span>
                               <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]],</span>
                              <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">insitu_df</span> <span class="o">=</span> <span class="n">insitu_df</span><span class="p">[</span><span class="n">insitu_df</span><span class="p">[</span><span class="s1">&#39;replicate&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">insitu_df</span> <span class="o">=</span> <span class="n">insitu_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;replicate&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jit</span><span class="p">:</span>
            <span class="n">insitu_2darray</span> <span class="o">=</span> <span class="n">insitu_df</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="n">img_array_1c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">insitu_2darray</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">insitu_2darray</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]))</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                                     <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">insitu_2darray</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]))</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="c1"># insitu_2darray[:,:-2] = max_normalize(insitu_2darray[:,:-2])</span>
            <span class="n">insitu_image</span> <span class="o">=</span> <span class="n">make_image_1c_njit</span><span class="p">(</span>
                <span class="n">data_2darray</span><span class="o">=</span><span class="n">insitu_2darray</span><span class="p">,</span> <span class="n">img_array_1c</span><span class="o">=</span><span class="n">img_array_1c</span><span class="p">,</span> <span class="n">remap_coord</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">insitu_2darray</span><span class="p">,</span> <span class="n">img_array_1c</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">insitu_image</span> <span class="o">=</span> <span class="n">make_image_1c</span><span class="p">(</span>
                <span class="n">data_2darray</span><span class="o">=</span><span class="n">insitu_df</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">remap_coord</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span><span class="o">*</span><span class="mf">1.5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span><span class="o">*</span><span class="mf">1.5</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span><span class="o">*</span><span class="mf">1.5</span><span class="p">})</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">tsne_embedding</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">im</span><span class="p">,</span> <span class="n">xy</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">insitu_image</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">tsne_embedding</span><span class="p">):</span>
            <span class="n">q_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">quantile</span><span class="p">)</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">q_max</span><span class="p">)</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">plot_image_at_point</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">xy</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="n">zoom</span><span class="p">,</span> <span class="n">color_scheme</span><span class="o">=</span><span class="s2">&quot;inferno&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Images in t-SNE Embedding&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;t-SNE 1&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;t-SNE 2&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/image_cluster/image_insitu_tsne&quot;</span><span class="p">)</span>

        <span class="c1"># cluster boxplot</span>
        <span class="n">image_cluster_df_long</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">cluster_mean_df</span><span class="p">,</span> <span class="n">id_vars</span><span class="o">=</span><span class="p">[</span>
                                        <span class="s1">&#39;ROI&#39;</span><span class="p">],</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;cluster&#39;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;intensity&#39;</span><span class="p">)</span>
        <span class="n">image_cluster_df_long</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">image_cluster_df_long</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">div</span><span class="p">(</span>
            <span class="n">image_cluster_df_long</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;cluster&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;max&#39;</span><span class="p">)[</span><span class="s1">&#39;intensity&#39;</span><span class="p">])</span>

        <span class="n">ROI</span> <span class="o">=</span> <span class="n">image_cluster_df_long</span><span class="p">[</span><span class="s2">&quot;ROI&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">image_cluster_df_long</span><span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="n">image_cluster_df_cluster</span> <span class="o">=</span> <span class="n">image_cluster_df_long</span><span class="p">[</span><span class="n">image_cluster_df_long</span><span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cluster</span><span class="p">]</span>
            <span class="n">pvalue</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">sm</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">anova_lm</span><span class="p">(</span>
                    <span class="n">ols</span><span class="p">(</span><span class="s1">&#39;intensity ~ C(ROI)&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">image_cluster_df_cluster</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                        <span class="p">(</span><span class="n">image_cluster_df_cluster</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">combo</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">|</span>
                        <span class="p">(</span><span class="n">image_cluster_df_cluster</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">combo</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                        <span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">,</span> <span class="s1">&#39;intensity&#39;</span><span class="p">]]</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(),</span>
                    <span class="n">typ</span><span class="o">=</span><span class="mi">1</span>
                <span class="p">)[</span><span class="s1">&#39;PR(&gt;F)&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">combo</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">combinations</span><span class="p">(</span><span class="n">ROI</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="mi">2</span><span class="p">))</span>
            <span class="p">]</span>
            <span class="n">model_pairs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">combo</span>
                <span class="k">for</span> <span class="n">combo</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">combinations</span><span class="p">(</span><span class="n">ROI</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="mi">2</span><span class="p">))</span>
            <span class="p">]</span>

            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span>
                <span class="p">(</span><span class="mi">10</span><span class="o">+</span><span class="n">math</span><span class="o">.</span><span class="n">comb</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ROI_num</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">7</span><span class="o">+</span><span class="n">math</span><span class="o">.</span><span class="n">comb</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ROI_num</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">10</span><span class="o">+</span><span class="n">math</span><span class="o">.</span><span class="n">comb</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ROI_num</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">)})</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">()</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;ROI&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;intensity&quot;</span><span class="p">,</span>
                        <span class="n">data</span><span class="o">=</span><span class="n">image_cluster_df_cluster</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">stripplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;ROI&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;intensity&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">image_cluster_df_cluster</span><span class="p">,</span>
                          <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">jitter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">annotator</span> <span class="o">=</span> <span class="n">Annotator</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">model_pairs</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;ROI&quot;</span><span class="p">,</span>
                                  <span class="n">y</span><span class="o">=</span><span class="s2">&quot;intensity&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">image_cluster_df_cluster</span><span class="p">)</span>
            <span class="n">formatted_pvalues</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">significance</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pvalue</span><span class="p">]</span>
            <span class="n">annotator</span><span class="o">.</span><span class="n">set_custom_annotations</span><span class="p">(</span><span class="n">formatted_pvalues</span><span class="p">)</span>
            <span class="n">annotator</span><span class="o">.</span><span class="n">annotate</span><span class="p">()</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Mean image of cluster </span><span class="si">{</span><span class="n">cluster</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;ROI&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Mean Intensity&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/image_cluster/boxplot_cluster</span><span class="si">{</span><span class="n">cluster</span><span class="si">}</span><span class="s2">.jpg&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

        <span class="n">image_cluster_all</span> <span class="o">=</span> <span class="n">image_cluster_all</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ROI&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jit</span><span class="p">:</span>
            <span class="n">insitu_2darray</span> <span class="o">=</span> <span class="n">image_cluster_all</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="n">img_array_1c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">insitu_2darray</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">insitu_2darray</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]))</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                                     <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">insitu_2darray</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]))</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">insitu_image</span> <span class="o">=</span> <span class="n">make_image_1c_njit</span><span class="p">(</span>
                <span class="n">data_2darray</span><span class="o">=</span><span class="n">insitu_2darray</span><span class="p">,</span> <span class="n">img_array_1c</span><span class="o">=</span><span class="n">img_array_1c</span><span class="p">,</span> <span class="n">remap_coord</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">insitu_2darray</span><span class="p">,</span> <span class="n">img_array_1c</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">insitu_image</span> <span class="o">=</span> <span class="n">make_image_1c</span><span class="p">(</span><span class="n">data_2darray</span><span class="o">=</span><span class="n">image_cluster_all</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                                         <span class="n">remap_coord</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">ROI_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ROI_info</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ROI_info</span><span class="p">[</span><span class="s2">&quot;replicate&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">replicate</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">analyte</span><span class="p">,</span> <span class="n">im</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">insitu_image</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;dark_background&#39;</span><span class="p">)</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">insitu_df</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">/</span><span class="mi">10</span><span class="p">})</span>
            <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
                <span class="c1"># image and legend grids</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">/</span><span class="mi">25</span><span class="p">],</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
            <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">im_plot</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">color_scheme</span><span class="p">)</span>
            <span class="n">draw_ROI</span><span class="p">(</span><span class="n">ROI_info</span><span class="p">,</span> <span class="n">show_ROI</span><span class="o">=</span><span class="n">show_ROI</span><span class="p">,</span>
                     <span class="n">show_square</span><span class="o">=</span><span class="n">show_square</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean image of cluster </span><span class="si">{</span><span class="n">analyte</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">colorbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im_plot</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
            <span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">im</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="n">colorbar</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">([</span><span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span><span class="p">])</span>
            <span class="n">colorbar</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/image_cluster/mean_image_cluster</span><span class="si">{</span><span class="n">analyte</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">image_cluster_all</span></div>

<div class="viewcode-block" id="DataAnalysis.make_boxplot"><a class="viewcode-back" href="../docs/data_analysis.html#data_analysis.DataAnalysis.make_boxplot">[docs]</a>    <span class="k">def</span> <span class="nf">make_boxplot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/boxplot&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/boxplot&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df_mean_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">,</span> <span class="s1">&#39;replicate&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_mean_all</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_mean_all</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_mean_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_mean_all</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df_mean_all</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">]</span>
                                            <span class="o">!=</span> <span class="s1">&#39;placeholder&#39;</span><span class="p">]</span>
        <span class="n">ROI</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_mean_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">df_mean_all_long</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_mean_all</span><span class="p">,</span> <span class="n">id_vars</span><span class="o">=</span><span class="p">[</span>
                                   <span class="s1">&#39;ROI&#39;</span><span class="p">,</span> <span class="s1">&#39;replicate&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;analyte&#39;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;intensity&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">analyte</span> <span class="ow">in</span> <span class="n">df_mean_all_long</span><span class="p">[</span><span class="s1">&#39;analyte&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="n">df_mean_all_analyte</span> <span class="o">=</span> <span class="n">df_mean_all_long</span><span class="p">[</span><span class="n">df_mean_all_long</span><span class="p">[</span><span class="s1">&#39;analyte&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">analyte</span><span class="p">]</span>
            <span class="n">pvalue</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">sm</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">anova_lm</span><span class="p">(</span>
                    <span class="n">ols</span><span class="p">(</span><span class="s1">&#39;intensity ~ C(ROI)&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df_mean_all_analyte</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                        <span class="p">(</span><span class="n">df_mean_all_analyte</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">combo</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">|</span>
                        <span class="p">(</span><span class="n">df_mean_all_analyte</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">combo</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                        <span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">,</span> <span class="s1">&#39;intensity&#39;</span><span class="p">]]</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(),</span>
                    <span class="n">typ</span><span class="o">=</span><span class="mi">1</span>
                <span class="p">)[</span><span class="s1">&#39;PR(&gt;F)&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">combo</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">combinations</span><span class="p">(</span><span class="n">ROI</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="mi">2</span><span class="p">))</span>
            <span class="p">]</span>
            <span class="n">model_pairs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">combo</span>
                <span class="k">for</span> <span class="n">combo</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">combinations</span><span class="p">(</span><span class="n">ROI</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="mi">2</span><span class="p">))</span>
            <span class="p">]</span>

            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span>
                <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="o">+</span><span class="n">math</span><span class="o">.</span><span class="n">comb</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ROI_num</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="o">+</span><span class="n">math</span><span class="o">.</span><span class="n">comb</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ROI_num</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;classic&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">7</span><span class="o">+</span><span class="n">math</span><span class="o">.</span><span class="n">comb</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ROI_num</span><span class="p">,</span> <span class="mi">2</span><span class="p">))})</span>

            <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;ROI&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;intensity&quot;</span><span class="p">,</span>
                        <span class="n">data</span><span class="o">=</span><span class="n">df_mean_all_analyte</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">stripplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;ROI&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;intensity&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df_mean_all_analyte</span><span class="p">,</span>
                          <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">jitter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">annotator</span> <span class="o">=</span> <span class="n">Annotator</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">model_pairs</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;ROI&quot;</span><span class="p">,</span>
                                  <span class="n">y</span><span class="o">=</span><span class="s2">&quot;intensity&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df_mean_all_analyte</span><span class="p">)</span>
            <span class="n">formatted_pvalues</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">significance</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pvalue</span><span class="p">]</span>
            <span class="n">annotator</span><span class="o">.</span><span class="n">set_custom_annotations</span><span class="p">(</span><span class="n">formatted_pvalues</span><span class="p">)</span>
            <span class="n">annotator</span><span class="o">.</span><span class="n">annotate</span><span class="p">()</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;m/z </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">analyte</span><span class="p">)]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;ROI&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Mean Intensity&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/boxplot/mz_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">analyte</span><span class="p">)]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">.jpg&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span></div></div>


<span class="c1"># visualize_data = DataAnalysis()</span>
<span class="c1"># visualize_data.load_preprocessed_data() # Z:\Lin\2024\python\Troy_Silverman\05-03-2024</span>
<span class="c1"># visualize_data.normalize_pixel(normalization = &quot;RMS&quot;)</span>
<span class="c1"># visualize_data.get_ion_image()</span>
<span class="c1"># visualize_data.make_FC_plot(pthreshold=0.05, FCthreshold=1.5)</span>
<span class="c1"># visualize_data.insitu_clustering(k=5, perplexity=20)</span>
<span class="c1"># visualize_data.image_clustering(k=5, perplexity=20)</span>
<span class="c1"># visualize_data.make_boxplot()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, yutinlin.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>