<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>iMSminer.data_analysis &mdash; iMSminer 1.0.1 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/fonts.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=292eb321"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            iMSminer
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../advanced.html">Advanced</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">iMSminer</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">iMSminer</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">iMSminer.data_analysis</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for iMSminer.data_analysis</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">iMSminer Alpha</span>
<span class="sd">@author: Yu Tin Lin (yutinlin@stanford.edu)</span>
<span class="sd">@author: Haohui Bao (susanab20020911@gmail.com)</span>
<span class="sd">@author: Troy R. Scoggins IV (t.scoggins@ufl.edu)</span>
<span class="sd">@author: Boone M. Prentice (booneprentice@ufl.chem.edu)</span>
<span class="sd">License: Apache-2.0</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">combinations</span><span class="p">,</span> <span class="n">permutations</span>

<span class="kn">import</span> <span class="nn">cv2</span>
<span class="kn">import</span> <span class="nn">matplotlib.colors</span> <span class="k">as</span> <span class="nn">mcolors</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">psutil</span>
<span class="kn">import</span> <span class="nn">seaborn</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">sklearn</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">from</span> <span class="nn">matplotlib.cm</span> <span class="kn">import</span> <span class="n">ScalarMappable</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">Normalize</span>
<span class="kn">from</span> <span class="nn">matplotlib.gridspec</span> <span class="kn">import</span> <span class="n">GridSpec</span>
<span class="kn">from</span> <span class="nn">matplotlib.lines</span> <span class="kn">import</span> <span class="n">Line2D</span>
<span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">jit</span>
<span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.manifold</span> <span class="kn">import</span> <span class="n">TSNE</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">calinski_harabasz_score</span><span class="p">,</span>
    <span class="n">davies_bouldin_score</span><span class="p">,</span>
    <span class="n">silhouette_score</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">PolynomialFeatures</span>
<span class="kn">from</span> <span class="nn">statannotations.Annotator</span> <span class="kn">import</span> <span class="n">Annotator</span>
<span class="kn">from</span> <span class="nn">statsmodels.formula.api</span> <span class="kn">import</span> <span class="n">ols</span>

<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">draw_ROI</span><span class="p">,</span>
    <span class="n">get_MS1_hits</span><span class="p">,</span>
    <span class="n">make_image_1c</span><span class="p">,</span>
    <span class="n">make_image_1c_njit</span><span class="p">,</span>
    <span class="n">plot_image_at_point</span><span class="p">,</span>
    <span class="n">repel_labels</span><span class="p">,</span>
    <span class="n">significance</span><span class="p">,</span>
    <span class="n">str2bool</span><span class="p">,</span>
<span class="p">)</span>


<div class="viewcode-block" id="DataAnalysis">
<a class="viewcode-back" href="../../iMSminer.html#iMSminer.data_analysis.DataAnalysis">[docs]</a>
<span class="k">class</span> <span class="nc">DataAnalysis</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs data analysis on preprocessed intensity matrix and coordinate arrays. Mass alignment function wasa refactored from the python module msalign (https://github.com/lukasz-migas/msalign)</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    data_dir : str, user input</span>
<span class="sd">        Path pointing to directory containing preprocessed data</span>
<span class="sd">    fig_ratio : str, user input</span>
<span class="sd">        Text:figure ratio for rendered figures from options `small`, `medium`, and `large`</span>
<span class="sd">    df_pixel_all : pd.DataFrame</span>
<span class="sd">        Dataframe of pixels by peaks with coordinates, ROIs, and replicates with columns mapped to m/z array</span>
<span class="sd">    mz : pd.Series</span>
<span class="sd">        Series of m/z values for peaks index mapped to columns of df_pixel_all</span>
<span class="sd">    ROI_info : pd.DataFrame</span>
<span class="sd">        Dataframe of ROI coordinates with ROI label and replicate number</span>
<span class="sd">    ROI_num : int, user input</span>
<span class="sd">        Number of ROIs in dataset</span>
<span class="sd">    ROIs : str, user input</span>
<span class="sd">        ROI annotations from left to right, top to bottom</span>
<span class="sd">    img_array_1c : np.ndarray</span>
<span class="sd">        Collection of single-channgled ion images with positions mapped to x,y coordinates</span>
<span class="sd">    ion_type : str, user input</span>
<span class="sd">        Ion types of MS1 hits</span>
<span class="sd">    mass_diff : float, user input</span>
<span class="sd">        Mass differences of ion types from monoisotopic neutural</span>
<span class="sd">    MS1_db_path : str, user input</span>
<span class="sd">        Local file path of MS1 database</span>
<span class="sd">    mz_col : int, user input</span>
<span class="sd">        Number denoting column in database corresponding to exact mass of monoisotopic neutral</span>
<span class="sd">    ms1_df : pd.DataFrame</span>
<span class="sd">        Dataframe containing a table of MS1 hits with chemical information</span>
<span class="sd">    analyte_class : list</span>
<span class="sd">        List of analyte classes contained in column class_col of ms1_df</span>
<span class="sd">    df_mean_all : pd.DataFrame</span>
<span class="sd">        Dataframe of mean intensities with groups ROIs and replicates</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span>
    <span class="p">):</span>
        <span class="n">detect_gpu</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;nvidia-smi&#39;</span><span class="p">,</span> <span class="s1">&#39;--query-gpu=name&#39;</span><span class="p">,</span> <span class="s1">&#39;--format=csv&#39;</span><span class="p">],</span>
                                    <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">detect_gpu</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;GPU Detected:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">detect_gpu</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

            <span class="n">test_library</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cupy&#39;</span><span class="p">,</span> <span class="s1">&#39;cudf&#39;</span><span class="p">,</span> <span class="s1">&#39;cuml&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">lib</span> <span class="ow">in</span> <span class="n">test_library</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">__import__</span><span class="p">(</span><span class="n">lib</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">lib</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> is installed and imported successfully!&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">gpu</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">lib</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s2"> is not installed or could not be imported.&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">gpu</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No GPU detected or NVIDIA driver not installed.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gpu</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="nb">__import__</span><span class="p">(</span><span class="s2">&quot;numba&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Numba is installed and imported successfully!&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jit</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Numba is not installed or could not be imported.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jit</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
            <span class="s2">&quot;Enter directory path containing image datasets: &quot;</span><span class="p">)</span>

        <span class="n">fig_ratio_chosen</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">fig_ratio_chosen</span><span class="p">:</span>
            <span class="n">fig_ratio</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
                <span class="s2">&quot;Render figures with `small`, `medium`, or `large` ratio? &quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">fig_ratio</span> <span class="o">==</span> <span class="s2">&quot;small&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span> <span class="o">=</span> <span class="mi">10</span>
                <span class="n">fig_ratio_chosen</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">fig_ratio</span> <span class="o">==</span> <span class="s2">&quot;medium&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span> <span class="o">=</span> <span class="mf">12.5</span>
                <span class="n">fig_ratio_chosen</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">fig_ratio</span> <span class="o">==</span> <span class="s2">&quot;large&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span> <span class="o">=</span> <span class="mi">15</span>
                <span class="n">fig_ratio_chosen</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fig_ratio_chosen</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Select one of the options.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="DataAnalysis.load_preprocessed_data">
<a class="viewcode-back" href="../../iMSminer.html#iMSminer.data_analysis.DataAnalysis.load_preprocessed_data">[docs]</a>
    <span class="k">def</span> <span class="nf">load_preprocessed_data</span><span class="p">(</span>
            <span class="bp">self</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        import preprocessed intensity matrix and coordinate arrays, perform ROI annotation and selection, and store information for further data analysis</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">datasets</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">)</span>
        <span class="n">datasets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">datasets</span><span class="p">)[(</span><span class="n">np</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">find</span><span class="p">(</span>
            <span class="n">datasets</span><span class="p">,</span> <span class="s2">&quot;coords&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">char</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="s2">&quot;csv&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_df_pixel_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="n">ROI_edge</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">rep</span><span class="p">,</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">datasets</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Importing </span><span class="si">{</span><span class="n">dataset</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="n">df_build</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">dataset</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished importing </span><span class="si">{</span><span class="n">dataset</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

            <span class="n">df_build</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Unnamed: 0&#39;</span><span class="p">:</span> <span class="s1">&#39;mz&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df_build</span> <span class="o">=</span> <span class="n">df_build</span><span class="o">.</span><span class="n">T</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_mz&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mz</span> <span class="o">=</span> <span class="n">df_build</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;mz&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mz</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">df_build</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;mz&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">df_coords</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">dataset</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="si">}</span><span class="s2">_coords.csv&quot;</span><span class="p">)</span>
            <span class="n">df_coords</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;0&#39;</span><span class="p">:</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span> <span class="s1">&#39;y&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df_coords</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_coords</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">df_coords</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">df_coords</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_coords</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">df_coords</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="n">df_build</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df_coords</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">df_build</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_build</span><span class="p">,</span> <span class="n">df_coords</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">img_array_1c</span> <span class="o">=</span> <span class="n">make_image_1c</span><span class="p">(</span><span class="n">data_2darray</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="n">df_build</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span> <span class="n">df_build</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">2</span><span class="p">:]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">img_array_1c</span> <span class="o">=</span> <span class="n">img_array_1c</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ROI_num</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Enter number of ROIs for analysis: &quot;</span><span class="p">))</span>
            <span class="n">ROIs</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
                <span class="s2">&quot;Enter labels for ROIs, from left to right, top to bottom? Separate ROI names by one space: &quot;</span><span class="p">)</span>
            <span class="n">ROIs</span> <span class="o">=</span> <span class="n">ROIs</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>

            <span class="c1"># ROI selection</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">module</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span> <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;google.colab&quot;</span><span class="p">,</span> <span class="s2">&quot;notebook&quot;</span><span class="p">]):</span>
                <span class="n">ROI_exit</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="n">ROI_exit</span><span class="p">:</span>
                    <span class="n">ROI_dim_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">ROI</span> <span class="ow">in</span> <span class="n">ROIs</span><span class="p">:</span>
                        <span class="n">ROI_dim</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">selectROI</span><span class="p">(</span>
                            <span class="s1">&#39;ROI_selection&#39;</span><span class="p">,</span> <span class="n">img_array_1c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">showCrosshair</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">ROI_dim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ROI_dim</span><span class="p">)</span>
                        <span class="n">ROI_dim_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">ROI_dim_array</span><span class="p">,</span> <span class="n">ROI_dim</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">cv2</span><span class="o">.</span><span class="n">destroyAllWindows</span><span class="p">()</span>
                    <span class="n">ROI_sele</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Keep ROI selecction? (yes/no) &quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ROI_sele</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
                        <span class="n">ROI_exit</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ROI_exit</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_array_1c</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

            <span class="n">df_build</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;placeholder&#39;</span>
            <span class="n">df_build</span><span class="p">[</span><span class="s1">&#39;ROI_num&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;placeholder&#39;</span>
            <span class="n">df_build</span><span class="p">[</span><span class="s1">&#39;replicate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rep</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ROI</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ROIs</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Select ROI </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">, labeled </span><span class="si">{</span><span class="n">ROI</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">bottom</span> <span class="o">=</span> <span class="n">ROI_dim_array</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">top</span> <span class="o">=</span> <span class="n">ROI_dim_array</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ROI_dim_array</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">left</span> <span class="o">=</span> <span class="n">ROI_dim_array</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">right</span> <span class="o">=</span> <span class="n">ROI_dim_array</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">ROI_dim_array</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

                    <span class="n">ROI_xy</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_build</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">left</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_build</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">right</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
                        <span class="n">df_build</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">bottom</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_build</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">top</span><span class="p">)</span>
                    <span class="n">df_build</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ROI_xy</span><span class="p">,</span> <span class="s2">&quot;ROI&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ROI</span>
                    <span class="n">df_build</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ROI_xy</span><span class="p">,</span> <span class="s2">&quot;ROI_num&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
                    <span class="n">ROI_edge</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">ROI_edge</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">ROI</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">rep</span><span class="p">])],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="c1"># ROI selection for jupyter notebook and Google colab</span>
                    <span class="n">left</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                        <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Enter lowest value on x (horizontal) coordinate: &quot;</span><span class="p">))</span>
                    <span class="n">right</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                        <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Enter highest value on x (horizontal) coordinate: &quot;</span><span class="p">))</span>
                    <span class="n">bottom</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                        <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Enter lowest value on y (vertical) coordinate: &quot;</span><span class="p">))</span>
                    <span class="n">top</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                        <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Enter highest value on y (vertical) coordinate: &quot;</span><span class="p">))</span>

                    <span class="n">ROI_xy</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_build</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">left</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_build</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">right</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
                        <span class="n">df_build</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">bottom</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df_build</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">top</span><span class="p">)</span>
                    <span class="n">df_build</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ROI_xy</span><span class="p">,</span> <span class="s2">&quot;ROI&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ROI</span>
                    <span class="n">ROI_edge</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">ROI_edge</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">ROI</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">rep</span><span class="p">])],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ROI </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> is selected and labeled </span><span class="si">{</span><span class="n">ROI</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_df_pixel_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_df_pixel_all</span><span class="p">,</span> <span class="n">df_build</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_df_pixel_all</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_df_pixel_all</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df_pixel_all</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df_pixel_all</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">ROI_edge</span> <span class="o">=</span> <span class="n">ROI_edge</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ROI_edge</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ROI&quot;</span><span class="p">,</span> <span class="s2">&quot;bottom&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="s2">&quot;replicate&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ROI_info</span> <span class="o">=</span> <span class="n">ROI_edge</span></div>


<div class="viewcode-block" id="DataAnalysis.calibrate_mz">
<a class="viewcode-back" href="../../iMSminer.html#iMSminer.data_analysis.DataAnalysis.calibrate_mz">[docs]</a>
    <span class="k">def</span> <span class="nf">calibrate_mz</span><span class="p">(</span>
            <span class="bp">self</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Interactive calibration using polynomial regression via linear model of user-specified degree</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        degree : int, user input</span>
<span class="sd">            Degree for linear model used in polynomial regression calibration</span>
<span class="sd">        reference_mz : 1darray, user input</span>
<span class="sd">            Reference massess to perform calibration on</span>
<span class="sd">        calibration_exit : str, user input</span>
<span class="sd">            Exits calibration if user specifies `yes`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/calibration&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/calibration&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>

        <span class="n">exit_regression</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">exit_regression</span><span class="p">:</span>
            <span class="n">degree</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Enter the degree of linear model for polynomial calibration. Enter an integer: &quot;</span><span class="p">))</span>
            <span class="n">reference_mz</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
                <span class="s2">&quot;Enter reference m/z&#39;s for calibration. Separate each reference m/z by one space: &quot;</span><span class="p">)</span>
            <span class="n">reference_mz</span> <span class="o">=</span> <span class="n">reference_mz</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="n">reference_mz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">reference_mz</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">resid_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span>
                <span class="nb">abs</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">-</span> <span class="n">reference_mz</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:])),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">resid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="p">[</span><span class="n">resid_index</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span> <span class="o">-</span> <span class="n">reference_mz</span>

            <span class="n">poly</span> <span class="o">=</span> <span class="n">PolynomialFeatures</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="n">degree</span><span class="p">,</span> <span class="n">include_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">poly_features_resid</span> <span class="o">=</span> <span class="n">poly</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="p">[</span><span class="n">resid_index</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">poly_reg_model</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">()</span>
            <span class="n">poly_reg_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">poly_features_resid</span><span class="p">,</span> <span class="n">resid</span><span class="p">)</span>
            <span class="n">R2</span> <span class="o">=</span> <span class="n">poly_reg_model</span><span class="o">.</span><span class="n">score</span><span class="p">(</span><span class="n">poly_features_resid</span><span class="p">,</span> <span class="n">resid</span><span class="p">)</span>

            <span class="n">poly_features</span> <span class="o">=</span> <span class="n">poly</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">resid_predicted</span> <span class="o">=</span> <span class="n">poly_reg_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">poly_features</span><span class="p">)</span>

            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
                <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span><span class="o">*</span><span class="mf">0.7</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="p">[</span><span class="n">resid_index</span><span class="p">],</span>
                       <span class="n">resid_predicted</span><span class="p">[</span><span class="n">resid_index</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="p">[</span><span class="n">resid_index</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
            <span class="n">resid_index_compl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="n">resid_index_compl</span><span class="p">[</span><span class="n">resid_index</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="p">[</span><span class="n">resid_index_compl</span><span class="p">],</span>
                       <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="p">[</span><span class="n">resid_index_compl</span><span class="p">]),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="p">[</span><span class="n">resid_index</span><span class="p">],</span> <span class="n">resid_predicted</span><span class="p">[</span><span class="n">resid_index</span><span class="p">]</span> <span class="o">/</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="p">[</span><span class="n">resid_index</span><span class="p">]</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Linear model of degree </span><span class="si">{</span><span class="n">degree</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Experimental m/z&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Residual [ppm]&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;$R^2 = </span><span class="si">{</span><span class="n">R2</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">$&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span>
                    <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

            <span class="n">calibration_exit</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
                <span class="s2">&quot;Accept changes to calibration? (yes/no/exit) &quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">calibration_exit</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mz</span> <span class="o">-=</span> <span class="n">resid_predicted</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/calibration/accepted_calibration_degree</span><span class="si">{</span><span class="n">degree</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
                <span class="n">exit_regression</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">calibration_exit</span> <span class="o">==</span> <span class="s2">&quot;no&quot;</span><span class="p">:</span>
                <span class="n">exit_regression</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">calibration_exit</span> <span class="o">==</span> <span class="s2">&quot;exit&quot;</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
                <span class="k">break</span></div>


<div class="viewcode-block" id="DataAnalysis.MS1_search">
<a class="viewcode-back" href="../../iMSminer.html#iMSminer.data_analysis.DataAnalysis.MS1_search">[docs]</a>
    <span class="k">def</span> <span class="nf">MS1_search</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">ppm_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
            <span class="n">MS1_search_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;avg_spectrum&quot;</span><span class="p">,</span>
            <span class="n">filter_db</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">percent_RAM</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;MS1 accurate mass search using database from user</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ppm_threshold : int, optional</span>
<span class="sd">            ppm threshold for MS1 accurate mass hits, by default 5</span>
<span class="sd">        MS1_search_method : str, optional</span>
<span class="sd">            Method for MS1 hits, by default `avg_spectrum`</span>
<span class="sd">            Method `avg_spectrum` performs MS1 search against an average spectrum</span>
<span class="sd">            Method `multi_spectrum` performs MS1 search against a collection of spectra stored in a csv file</span>
<span class="sd">        filter_db : bool, optional</span>
<span class="sd">            Filters MS1 database prior to accurate mass search if `filter_db = True`, by default True</span>
<span class="sd">        percent_RAM : float, optional</span>
<span class="sd">            Percent available RAM to define size of chunking, by deafult 5</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ion_type</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
            <span class="s2">&quot;Enter ion types of interest. Separate each ion type by one space: &quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ion_type</span> <span class="o">=</span> <span class="n">ion_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="n">mass_diff</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
            <span class="s2">&quot;Enter the corresponding mass difference of ion type(s) of interest. List ion types in same order as previously and separate each ion type by one space: &quot;</span><span class="p">)</span>
        <span class="n">mass_diff</span> <span class="o">=</span> <span class="n">mass_diff</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mass_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mass_diff</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="n">MS1_db_path</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
            <span class="s2">&quot;Enter file path of MS1 database in csv format: &quot;</span><span class="p">)</span>
        <span class="n">mz_col</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span>
            <span class="s2">&quot;Enter column in MS1 database that corresponds to neurtral monoisotopic masses: &quot;</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Importing MS1 database. . .&quot;</span><span class="p">)</span>
        <span class="n">MS1_db</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">MS1_db_path</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finished importing MS1 database!&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The columns of imported database are </span><span class="si">{</span><span class="n">MS1_db</span><span class="o">.</span><span class="n">columns</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">filter_db</span> <span class="o">=</span> <span class="n">str2bool</span><span class="p">(</span>
            <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Filter database? Recommended for speed. Enter (yes / no) &quot;</span><span class="p">))</span>

        <span class="c1"># reduce database</span>
        <span class="k">if</span> <span class="n">filter_db</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">col_filter</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Which column [number] in database to perform filtering? &quot;</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">filter_by</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Enter the groups of interest for filtering column </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">col_filter</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> in MS1 database. Separate each group by one space: &quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">filter_by</span> <span class="o">=</span> <span class="n">filter_by</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="n">MS1_db</span> <span class="o">=</span> <span class="n">MS1_db</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">MS1_db</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_filter</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span>
                <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_by</span><span class="p">))]</span>
            <span class="n">MS1_db</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">all_rows</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">MS1_db</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">MS1_db</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">mz_col</span><span class="p">]:</span> <span class="s1">&#39;exact_mass&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">MS1_search_method</span> <span class="o">==</span> <span class="s2">&quot;avg_spectrum&quot;</span><span class="p">:</span>
            <span class="n">mz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">mz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mz</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">mz_diff</span><span class="p">,</span> <span class="n">adduct</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_diff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ion_type</span><span class="p">):</span>
                <span class="n">MS1</span> <span class="o">=</span> <span class="n">MS1_db</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">MS1</span><span class="p">[</span><span class="s2">&quot;ion_mass&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MS1</span><span class="p">[</span><span class="s2">&quot;exact_mass&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">mz_diff</span>
                <span class="n">MS1</span><span class="p">[</span><span class="s2">&quot;ion_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adduct</span>
                <span class="n">MS1_db_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">MS1</span><span class="p">)</span>
                <span class="n">MS1_ion_mass</span> <span class="o">=</span> <span class="n">MS1</span><span class="p">[</span><span class="s2">&quot;ion_mass&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="n">MS1_hit_indices</span><span class="p">,</span> <span class="n">ppm</span> <span class="o">=</span> <span class="n">get_MS1_hits</span><span class="p">(</span>
                    <span class="n">mz</span><span class="p">,</span> <span class="n">MS1_ion_mass</span><span class="p">,</span> <span class="n">ppm_threshold</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">analyte_pointer</span><span class="p">,</span> <span class="n">ion_index</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">MS1_hit_indices</span><span class="p">):</span>
                    <span class="n">combined_row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">analyte_pointer</span><span class="p">),</span> <span class="n">ppm</span><span class="p">[</span><span class="n">analyte_pointer</span><span class="p">,</span> <span class="n">ion_index</span><span class="p">]],</span> <span class="n">MS1_db_array</span><span class="p">[</span><span class="n">ion_index</span><span class="p">])</span>
                    <span class="n">all_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">combined_row</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">MS1_search_method</span> <span class="o">==</span> <span class="s2">&quot;multi_spectrum&quot;</span><span class="p">:</span>
            <span class="n">mz_list_path</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Enter the file path of list of m/z&#39;s: &quot;</span><span class="p">)</span>
            <span class="n">mz</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">mz_list_path</span><span class="p">)</span>
            <span class="n">analyte_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">mz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">mz</span> <span class="o">=</span> <span class="n">mz</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">mz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">analyte_index</span><span class="p">,</span> <span class="n">mz</span><span class="p">))</span>
            <span class="n">RAM_available</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">virtual_memory</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">num_chunks</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">MS1_db_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span>
                             <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">/</span> <span class="p">(</span><span class="n">RAM_available</span> <span class="o">*</span> <span class="n">percent_RAM</span><span class="o">/</span><span class="mi">100</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">chunk_size_base</span> <span class="o">=</span> <span class="n">mz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="n">num_chunks</span>
            <span class="n">remainder</span> <span class="o">=</span> <span class="n">mz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">%</span> <span class="n">num_chunks</span>
            <span class="k">for</span> <span class="n">mz_diff</span><span class="p">,</span> <span class="n">adduct</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_diff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ion_type</span><span class="p">):</span>
                <span class="n">MS1</span> <span class="o">=</span> <span class="n">MS1_db</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">MS1</span><span class="p">[</span><span class="s2">&quot;ion_mass&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">MS1</span><span class="p">[</span><span class="s2">&quot;exact_mass&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">mz_diff</span>
                <span class="n">MS1</span><span class="p">[</span><span class="s2">&quot;ion_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adduct</span>
                <span class="n">MS1_db_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">MS1</span><span class="p">)</span>
                <span class="n">MS1_ion_mass</span> <span class="o">=</span> <span class="n">MS1</span><span class="p">[</span><span class="s2">&quot;ion_mass&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="n">chunk_start</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_chunks</span><span class="p">):</span>
                    <span class="n">chunk_size_temp</span> <span class="o">=</span> <span class="n">chunk_size_base</span>
                    <span class="k">if</span> <span class="n">remainder</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">:</span>
                        <span class="n">chunk_size_temp</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;mz_chunk: </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">; chunck_size: </span><span class="si">{</span><span class="n">chunk_size_temp</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">chunk_start</span> <span class="o">+=</span> <span class="n">chunk_size_temp</span>
                    <span class="n">mz_chunk</span> <span class="o">=</span> <span class="n">mz</span><span class="p">[</span><span class="n">chunk_start</span><span class="p">:(</span><span class="n">chunk_start</span><span class="o">+</span><span class="n">chunk_size_temp</span><span class="p">)]</span>
                    <span class="n">MS1_hit_indices</span><span class="p">,</span> <span class="n">ppm</span> <span class="o">=</span> <span class="n">get_MS1_hits</span><span class="p">(</span>
                        <span class="n">mz_chunk</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">MS1_ion_mass</span><span class="p">,</span> <span class="n">ppm_threshold</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">analyte_pointer</span><span class="p">,</span> <span class="n">ion_index</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">MS1_hit_indices</span><span class="p">):</span>
                        <span class="n">combined_row</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">mz</span><span class="p">[</span><span class="n">analyte_pointer</span><span class="o">+</span><span class="n">chunk_start</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">ppm</span><span class="p">[</span><span class="n">analyte_pointer</span><span class="p">,</span> <span class="n">ion_index</span><span class="p">]],</span> <span class="n">MS1_db_array</span><span class="p">[</span><span class="n">ion_index</span><span class="p">])</span>
                        <span class="n">all_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">combined_row</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ms1_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">all_rows</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;analyte&#39;</span><span class="p">,</span> <span class="s1">&#39;ppm&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">MS1</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">MS1_search_method</span> <span class="o">==</span> <span class="s2">&quot;multi_spectrum&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ms1_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms1_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ms1_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">]]))</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
                <span class="n">frequency</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;ppm&#39;</span><span class="p">,</span> <span class="s1">&#39;size&#39;</span><span class="p">),</span>
                <span class="n">ppm_mean</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;ppm&#39;</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">),</span>
                <span class="n">ppm_std</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;ppm&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ms1_df</span><span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">mz</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">mz</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span></div>


<div class="viewcode-block" id="DataAnalysis.filter_analytes">
<a class="viewcode-back" href="../../iMSminer.html#iMSminer.data_analysis.DataAnalysis.filter_analytes">[docs]</a>
    <span class="k">def</span> <span class="nf">filter_analytes</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;MS1&quot;</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Subset peak-picked untargeted data to analytes of interest</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        method : str, optional</span>
<span class="sd">            Type of filtering, by default &quot;MS1&quot;</span>
<span class="sd">            Method `MS1&quot; subsets` untargeted data to MS1 hits</span>
<span class="sd">            Method `analyte_class` subsets untargeted data to analyte classes from MS1 hits</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filtering analytes by </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">truncate_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">columns</span> <span class="o">==</span> <span class="s2">&quot;x&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;MS1&quot;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;MS2&quot;</span><span class="p">:</span>
            <span class="n">MS2_path</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Enter file path of MS2 results: &quot;</span><span class="p">)</span>
            <span class="n">MS2_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">MS2_path</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ms1_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">==</span> <span class="s2">&quot;adduct&quot;</span><span class="p">):</span>
                <span class="n">ion_type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ms1_df</span><span class="p">[</span><span class="s1">&#39;ion_type&#39;</span><span class="p">])</span>
                <span class="n">adduct_mapping</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Map </span><span class="si">{</span><span class="n">ion_type</span><span class="si">}</span><span class="s2"> to the following. Separate each value by one space: &quot;</span><span class="p">)</span>
                <span class="n">adduct_mapping</span> <span class="o">=</span> <span class="n">adduct_mapping</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
                <span class="n">mapping_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">ion_type</span><span class="p">,</span> <span class="n">adduct_mapping</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ms1_df</span><span class="p">[</span><span class="s1">&#39;adduct&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms1_df</span><span class="p">[</span><span class="s1">&#39;ion_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                    <span class="n">mapping_dict</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
            <span class="n">analyte_col</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Enter column number that corresponds to analyte IDs. The columns are </span><span class="se">\n</span><span class="s2">&quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ms1_df</span><span class="o">.</span><span class="n">columns</span><span class="si">}</span><span class="s2">: &quot;</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">ms1_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ms1_df</span><span class="p">,</span> <span class="n">MS2_results</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ms1_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">analyte_col</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;adduct&#39;</span><span class="p">],</span> <span class="n">right_on</span><span class="o">=</span><span class="p">[</span>
                                   <span class="s1">&#39;bulk_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;adduct&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_ms2&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ms1_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms1_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ms1_df</span><span class="p">[[</span>
                <span class="s2">&quot;adduct&quot;</span><span class="p">,</span> <span class="s2">&quot;ns_ID&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;analyte_class&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The columns in MS1 dataframe are </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ms1_df</span><span class="o">.</span><span class="n">columns</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">class_col</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Enter column [number] in MS1 dataframe corresponds to analyte class? The columns are </span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ms1_df</span><span class="o">.</span><span class="n">columns</span><span class="si">}</span><span class="s2">: &quot;</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">analyte_class</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
                <span class="s2">&quot;Enter analyte classes of interest. Separate each analyte class by one space: &quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">analyte_class</span> <span class="o">=</span> <span class="n">analyte_class</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ms1_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ms1_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">class_col</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span>
                <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">analyte_class</span><span class="p">))]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;ion_type&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The columns in MS1 dataframe are </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ms1_df</span><span class="o">.</span><span class="n">columns</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">ion_col</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                <span class="nb">input</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Enter column [number] MS1 dataframe that corresponds to ion type. The columns are </span><span class="se">\n</span><span class="s2">&quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ms1_df</span><span class="o">.</span><span class="n">columns</span><span class="si">}</span><span class="s2">: &quot;</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">ion_type</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
                <span class="s2">&quot;Enter ion types of interest. Separate each ion type by one space: &quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ms1_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ms1_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">ion_col</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span>
                <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ion_type</span><span class="p">))]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Method not recognized. Please choose from options specified in documentation. &quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No filtering was performed.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ms1_df</span><span class="p">[</span><span class="s1">&#39;analyte&#39;</span><span class="p">])],</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">truncate_col</span><span class="p">:]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ms1_df</span><span class="p">[</span><span class="s1">&#39;analyte&#39;</span><span class="p">])]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">analyte_mapping</span> <span class="o">=</span> <span class="p">{</span><span class="n">old_analyte</span><span class="p">:</span> <span class="n">new_analyte</span> <span class="k">for</span> <span class="n">new_analyte</span><span class="p">,</span>
                           <span class="n">old_analyte</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ms1_df</span><span class="p">[</span><span class="s1">&#39;analyte&#39;</span><span class="p">]))}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ms1_df</span><span class="p">[</span><span class="s1">&#39;analyte&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms1_df</span><span class="p">[</span><span class="s1">&#39;analyte&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="n">analyte_mapping</span><span class="p">)</span>
        <span class="n">truncate_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">columns</span> <span class="o">==</span> <span class="s2">&quot;x&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">truncate_col</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
            <span class="nb">str</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">truncate_col</span><span class="p">:])</span></div>


<div class="viewcode-block" id="DataAnalysis.normalize_pixel">
<a class="viewcode-back" href="../../iMSminer.html#iMSminer.data_analysis.DataAnalysis.normalize_pixel">[docs]</a>
    <span class="k">def</span> <span class="nf">normalize_pixel</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;TIC&quot;</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Normalize pixels using specified method</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        method : str, optional</span>
<span class="sd">            Method to compute normalization factor, by default &quot;TIC&quot;</span>
<span class="sd">            Method `TIC` normalizes on total ion count over each pixel</span>
<span class="sd">            Method `RMS` normalizes on root mean square over each pixel</span>
<span class="sd">            Method `reference` normalizes on a reference analyte specified by m/z or index</span>
<span class="sd">            Method `max` normalizes on maximum intensity of each pixel</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Normalizing pixels with </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">truncate_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">columns</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;TIC&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">div</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;RMS&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;reference&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Pixels with reference intensity = 0 are normalized on the reference mean&quot;</span><span class="p">)</span>
            <span class="n">mz_reference</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Enter m/z of reference mass: &quot;</span><span class="p">))</span>
            <span class="n">ref_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mz</span> <span class="o">-</span> <span class="n">mz_reference</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">div</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">ref_col</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">ref_col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">x</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">div</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Normalization method not found. Default to no normalization&quot;</span><span class="p">)</span>
            <span class="k">pass</span></div>


<div class="viewcode-block" id="DataAnalysis.get_ion_image">
<a class="viewcode-back" href="../../iMSminer.html#iMSminer.data_analysis.DataAnalysis.get_ion_image">[docs]</a>
    <span class="k">def</span> <span class="nf">get_ion_image</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">replicate</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">show_ROI</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">show_square</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">color_scheme</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;inferno&quot;</span><span class="p">,</span>
            <span class="n">ROI_size_divisor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
            <span class="n">quantile</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Render ion image for analytes in self._df_pixel_all (filtered or unfiltered)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        replicate : int, optional</span>
<span class="sd">            Render image from replicate (dataset) #, by default 0</span>
<span class="sd">        show_ROI : bool, optional</span>
<span class="sd">            Display ROI label above redenred ion image, by default True</span>
<span class="sd">        show_square : bool, optional</span>
<span class="sd">            Display a green box around selected ROI in rendered ion image, by default False</span>
<span class="sd">        color_scheme : str, optional</span>
<span class="sd">            False-color scheme for ion image visualization, by default &quot;inferno&quot;. A list of color schemes are available here: https://matplotlib.org/stable/users/explain/colors/colormaps.html</span>
<span class="sd">        ROI_size_divisor : float, optional</span>
<span class="sd">            Controls size of ROI labels, where a smaller divisor gives a larger ROI label, by default 8</span>
<span class="sd">        quantile : float, optional</span>
<span class="sd">            Quantile of intensity (possible values in [0, 100]) for ion image visualization, by default 100</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/ion_image&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/ion_image&quot;</span><span class="p">)</span>
        <span class="n">resolution</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
            <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Enter spatial resolution of imaging [microns]: &quot;</span><span class="p">))</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>

        <span class="n">truncate_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">columns</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span> <span class="o">-</span>
                               <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">insitu_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="p">[</span><span class="s1">&#39;replicate&#39;</span><span class="p">],</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]],</span>
                              <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">insitu_df</span> <span class="o">=</span> <span class="n">insitu_df</span><span class="p">[</span><span class="n">insitu_df</span><span class="p">[</span><span class="s1">&#39;replicate&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">replicate</span><span class="p">]</span>
        <span class="n">insitu_df</span> <span class="o">=</span> <span class="n">insitu_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;replicate&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jit</span><span class="p">:</span>
            <span class="n">insitu_2darray</span> <span class="o">=</span> <span class="n">insitu_df</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="n">img_array_1c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">insitu_2darray</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">insitu_2darray</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]))</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                                     <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">insitu_2darray</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]))</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">insitu_image</span> <span class="o">=</span> <span class="n">make_image_1c_njit</span><span class="p">(</span>
                <span class="n">data_2darray</span><span class="o">=</span><span class="n">insitu_2darray</span><span class="p">,</span> <span class="n">img_array_1c</span><span class="o">=</span><span class="n">img_array_1c</span><span class="p">,</span> <span class="n">remap_coord</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">insitu_2darray</span><span class="p">,</span> <span class="n">img_array_1c</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">insitu_image</span> <span class="o">=</span> <span class="n">make_image_1c</span><span class="p">(</span>
                <span class="n">data_2darray</span><span class="o">=</span><span class="n">insitu_df</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">remap_coord</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">ROI_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ROI_info</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ROI_info</span><span class="p">[</span><span class="s2">&quot;replicate&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">replicate</span><span class="p">]</span>
        <span class="n">ROI_info</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">show_ROI</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">show_square</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">width_ratios</span> <span class="o">=</span> <span class="p">(</span><span class="n">ROI_info</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">ROI_info</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">]</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">width_ratios</span> <span class="o">/=</span> <span class="nb">max</span><span class="p">(</span><span class="n">width_ratios</span><span class="p">)</span>
        <span class="n">width_ratios</span> <span class="o">=</span> <span class="n">width_ratios</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="mi">20</span><span class="p">})</span>
        <span class="n">ROI_label_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="n">ROI_info</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">ROI_info</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">ROI_size_divisor</span>
        <span class="k">for</span> <span class="n">analyte</span><span class="p">,</span> <span class="n">im</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">insitu_image</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;dark_background&#39;</span><span class="p">)</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span>
                <span class="n">ROI_info</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="n">width_ratios</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">],</span> <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
            <span class="n">q_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">quantile</span><span class="p">)</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">q_max</span><span class="p">)</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">ROI_max</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">ax_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ROI_info</span><span class="p">)):</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax_index</span><span class="p">])</span>
                <span class="n">ROI</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ROI_info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ax_index</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
                <span class="n">start_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ROI</span><span class="o">.</span><span class="n">columns</span> <span class="o">==</span> <span class="s2">&quot;bottom&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">truncate_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ROI_info</span><span class="o">.</span><span class="n">columns</span> <span class="o">==</span> <span class="s2">&quot;right&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">squares</span> <span class="o">=</span> <span class="n">ROI</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">start_col</span><span class="p">:</span><span class="n">truncate_col</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                <span class="n">im_ROI</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">squares</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]):(</span><span class="nb">int</span><span class="p">(</span><span class="n">squares</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
                            <span class="nb">int</span><span class="p">(</span><span class="n">squares</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]):(</span><span class="nb">int</span><span class="p">(</span><span class="n">squares</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">im_ROI</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ROI_max</span><span class="p">:</span>
                    <span class="n">ROI_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">im_ROI</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im_ROI</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">color_scheme</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">square</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">squares</span><span class="p">):</span>
                    <span class="n">bottom</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="n">square</span>
                    <span class="n">top</span> <span class="o">-=</span> <span class="n">bottom</span>
                    <span class="n">bottom</span> <span class="o">-=</span> <span class="n">bottom</span>
                    <span class="n">right</span> <span class="o">-=</span> <span class="n">left</span>
                    <span class="n">left</span> <span class="o">-=</span> <span class="n">left</span>
                    <span class="n">x_coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">left</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">left</span><span class="p">]</span>
                    <span class="n">y_coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">bottom</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">bottom</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">show_square</span><span class="p">:</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_coords</span><span class="p">,</span> <span class="n">y_coords</span><span class="p">,</span> <span class="s1">&#39;g-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">show_ROI</span><span class="p">:</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">right</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">bottom</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ROI</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                 <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">ROI_label_size</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
            <span class="n">cax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;m/z </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="p">[</span><span class="n">analyte</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                         <span class="n">fontsize</span><span class="o">=</span><span class="n">ROI_label_size</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
            <span class="n">scalar_mappable</span> <span class="o">=</span> <span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">color_scheme</span><span class="p">)</span>
            <span class="n">scalar_mappable</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">quantile</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span>
            <span class="n">colorbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span>
                <span class="n">scalar_mappable</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
            <span class="n">colorbar</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">quantile</span><span class="o">/</span><span class="mi">100</span><span class="p">])</span>
            <span class="n">colorbar</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">quantile</span><span class="p">])</span>
            <span class="n">cax</span><span class="o">.</span><span class="n">set_position</span><span class="p">([</span><span class="n">cax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">cax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">y0</span> <span class="o">+</span> <span class="n">cax</span><span class="o">.</span><span class="n">get_position</span><span class="p">(</span>
            <span class="p">)</span><span class="o">.</span><span class="n">height</span> <span class="o">*</span> <span class="mf">0.25</span><span class="p">,</span> <span class="n">cax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">cax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">height</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">])</span>
            <span class="n">cax_pos</span> <span class="o">=</span> <span class="n">cax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span>
            <span class="n">line_y</span> <span class="o">=</span> <span class="n">cax_pos</span><span class="o">.</span><span class="n">y1</span> <span class="o">+</span> <span class="mf">0.05</span>
            <span class="n">line_x_start</span> <span class="o">=</span> <span class="n">cax_pos</span><span class="o">.</span><span class="n">x0</span>
            <span class="n">line_x_end</span> <span class="o">=</span> <span class="n">cax_pos</span><span class="o">.</span><span class="n">x1</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">Line2D</span><span class="p">([</span><span class="n">line_x_start</span><span class="p">,</span> <span class="n">line_x_end</span><span class="p">],</span> <span class="p">[</span><span class="n">line_y</span><span class="p">,</span> <span class="n">line_y</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span>
                          <span class="n">transform</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">transFigure</span><span class="p">,</span> <span class="n">clip_on</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">ROI_label_size</span><span class="o">/</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">resolution_plt</span> <span class="o">=</span> <span class="n">resolution</span> <span class="o">*</span> \
                <span class="nb">max</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ROI_info</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">ROI_info</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">line_x_end</span><span class="o">-</span><span class="n">line_x_start</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ROI_num</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="n">line_x_start</span> <span class="o">+</span> <span class="n">line_x_end</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">line_y</span> <span class="o">+</span> <span class="mf">0.02</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">resolution_plt</span><span class="si">:</span><span class="s1"> .0f</span><span class="si">}</span><span class="s1"> $\mu$m&#39;</span><span class="p">,</span>
                     <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">ROI_label_size</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/ion_image/mz_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="p">[</span><span class="n">analyte</span><span class="p">]</span><span class="si">:</span><span class="s2"> .3f</span><span class="si">}</span><span class="s2">_replicate</span><span class="si">{</span><span class="n">replicate</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">,</span>
                        <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="DataAnalysis.make_FC_plot">
<a class="viewcode-back" href="../../iMSminer.html#iMSminer.data_analysis.DataAnalysis.make_FC_plot">[docs]</a>
    <span class="k">def</span> <span class="nf">make_FC_plot</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">pthreshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
            <span class="n">FCthreshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
            <span class="n">legend_label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;condition&quot;</span><span class="p">,</span>
            <span class="n">feature_label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mz&quot;</span><span class="p">,</span>
            <span class="n">hm_label</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mz&quot;</span><span class="p">,</span>
            <span class="n">jitter_amount</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">jitter_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
            <span class="n">font_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
            <span class="n">get_hm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">hm_width_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
            <span class="n">hm_height_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
            <span class="n">hm_fontsize</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
            <span class="n">hm_wspace</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate volcano plots of permuted ROI pairs, showing fold-change statistics and p-values</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pthreshold : float, optional</span>
<span class="sd">            P-value threshold for statistical significance in volcano plot, by default 0.05</span>
<span class="sd">        FCthreshold : float, optional</span>
<span class="sd">            Absolute fold change threshold for significant dysregulation in volcano plot, by default 1.5</span>
<span class="sd">        legend_label : str, optional</span>
<span class="sd">            Labeling scheme for legend of volcano plot, by default `condition`</span>
<span class="sd">            Method `condition` colors data points by expression condition</span>
<span class="sd">            Method `analyte_class` colors significant data points by class of analyte from MS1 search. Prequisite: DataAnalysis.MS1_search()</span>
<span class="sd">        feature_label : str, optional</span>
<span class="sd">            Labeling scehem for data points in volcano plot, by default `mz`</span>
<span class="sd">            Method `mz` labels significant data points by their corresponding m/z values</span>
<span class="sd">            Method `analyte` labels significant data points by their corresponding analylte IDs.Prequisite: DataAnalysis.MS1_search()</span>
<span class="sd">        jitter_amount : float, optional</span>
<span class="sd">            Controls placement of feature label in volcano plot, by default 2</span>
<span class="sd">        jitter_factor : float, optional</span>
<span class="sd">            Controls the repulsiveness of neighboring feature labels, by deafult 100</span>
<span class="sd">        font_size : float, optional</span>
<span class="sd">            Font size of feature labels in volcano plot, by default 15</span>
<span class="sd">        get_hm : bool, optional</span>
<span class="sd">            Renders a heatmap of feature label by ROI with entries fold change if `get_hm = True`, by deafult True</span>
<span class="sd">        hm_width_factor : float, optional</span>
<span class="sd">            Controls width of heatmaps</span>
<span class="sd">        hm_height_factor : float, optional</span>
<span class="sd">            Controls height of heatmap</span>
<span class="sd">        hm_fontsize : float, optional</span>
<span class="sd">            Controls font size in heatmap</span>
<span class="sd">        hm_wspace : float ,optional</span>
<span class="sd">            Controls column spacing between heatmaps</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/volcano&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/volcano&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/volcano_unlabeled&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/volcano_unlabeled&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">feature_label</span> <span class="o">==</span> <span class="s2">&quot;analyte&quot;</span><span class="p">:</span>
            <span class="n">analyte_col</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Enter column number that corresponds to analyte IDs. </span><span class="se">\n</span><span class="s2">&quot;</span>
                                    <span class="sa">f</span><span class="s2">&quot;The columns are </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ms1_df</span><span class="o">.</span><span class="n">columns</span><span class="si">}</span><span class="s2">: &quot;</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="c1"># prepare dataframe for p-value and FC computations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_mean_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">,</span> <span class="s1">&#39;replicate&#39;</span><span class="p">,</span> <span class="s1">&#39;ROI_num&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_mean_all</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_mean_all</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_mean_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_mean_all</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df_mean_all</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">]</span>
                                            <span class="o">!=</span> <span class="s1">&#39;placeholder&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_mean_all</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Needs at least 2 ROIs.&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">df_mean_all_long</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_mean_all</span><span class="p">,</span> <span class="n">id_vars</span><span class="o">=</span><span class="p">[</span>
                                   <span class="s1">&#39;ROI&#39;</span><span class="p">,</span> <span class="s1">&#39;replicate&#39;</span><span class="p">,</span> <span class="s1">&#39;ROI_num&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;analyte&#39;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;intensity&#39;</span><span class="p">)</span>
        <span class="n">df_mean_all_long</span><span class="p">[</span><span class="s1">&#39;analyte&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_mean_all_long</span><span class="p">[</span><span class="s1">&#39;analyte&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">df_FC</span> <span class="o">=</span> <span class="n">df_mean_all_long</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">,</span> <span class="s1">&#39;analyte&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">df_hm</span> <span class="o">=</span> <span class="n">df_FC</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting to generate volcano plots.&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">combo</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">permutations</span><span class="p">(</span><span class="n">df_FC</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)):</span>
            <span class="n">df_FC_pair</span> <span class="o">=</span> <span class="n">df_FC</span><span class="p">[(</span><span class="n">df_FC</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">combo</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">|</span>
                               <span class="p">(</span><span class="n">df_FC</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">combo</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">df_FC_pair</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analyte(s) </span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="p">[(</span><span class="n">df_FC_pair</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span><span class="si">}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">have a zero mean intensity in </span><span class="se">\n</span><span class="s2">&quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">combo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">. Excluded from volcano plot </span><span class="si">{</span><span class="n">combo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="n">combo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">. &quot;</span><span class="p">)</span>
                <span class="n">df_FC_pair</span> <span class="o">=</span> <span class="n">df_FC_pair</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">df_FC_pair</span><span class="p">[</span><span class="s1">&#39;analyte&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span>
                    <span class="n">df_FC_pair</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_FC_pair</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;analyte&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">())]</span>
            <span class="n">reference_intensity</span> <span class="o">=</span> <span class="n">df_FC_pair</span><span class="p">[</span><span class="n">df_FC_pair</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">combo</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;analyte&#39;</span><span class="p">)[</span>
                <span class="s1">&#39;intensity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">df_FC_pair</span> <span class="o">=</span> <span class="n">df_FC_pair</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
                <span class="n">reference_intensity</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;analyte&#39;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;_ref&#39;</span><span class="p">))</span>
            <span class="n">df_FC_pair</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">df_FC_pair</span><span class="p">[</span><span class="s1">&#39;intensity_ref&#39;</span><span class="p">]</span>

            <span class="n">df_FC_pair</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">df_FC_pair</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">])</span>

            <span class="n">df_FC_pair</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="c1"># compute p-value for each analyte</span>
            <span class="k">for</span> <span class="n">analyte_sele</span> <span class="ow">in</span> <span class="n">df_FC_pair</span><span class="p">[</span><span class="s1">&#39;analyte&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                <span class="n">df_analyte</span> <span class="o">=</span> <span class="n">df_mean_all_long</span><span class="p">[</span><span class="n">df_mean_all_long</span><span class="p">[</span><span class="s1">&#39;analyte&#39;</span><span class="p">]</span>
                                              <span class="o">==</span> <span class="n">analyte_sele</span><span class="p">]</span>
                <span class="n">lm_df</span> <span class="o">=</span> <span class="n">ols</span><span class="p">(</span><span class="s1">&#39;intensity ~ C(ROI)&#39;</span><span class="p">,</span>
                            <span class="n">data</span><span class="o">=</span><span class="n">df_analyte</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">lm_df</span><span class="o">.</span><span class="n">df_resid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="s2">&quot;Insufficient sample size for computing p-values.&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
                <span class="c1">#    return None</span>

                <span class="n">anova_df</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">anova_lm</span><span class="p">(</span><span class="n">lm_df</span><span class="p">,</span> <span class="n">typ</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

                <span class="n">df_FC_pair</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_FC_pair</span><span class="p">[</span><span class="s1">&#39;analyte&#39;</span><span class="p">]</span> <span class="o">==</span>
                               <span class="n">analyte_sele</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">anova_df</span><span class="p">[</span><span class="s1">&#39;PR(&gt;F)&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">df_FC_pair</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">df_FC_pair</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">])</span>
                <span class="n">df_FC_pair</span><span class="p">[</span><span class="s1">&#39;legend&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;placeholder&quot;</span>
                <span class="n">df_vp</span> <span class="o">=</span> <span class="n">df_FC_pair</span><span class="p">[</span><span class="n">df_FC_pair</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">]</span>
                                   <span class="o">==</span> <span class="n">combo</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;analyte&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">legend_label</span> <span class="o">==</span> <span class="s2">&quot;condition&quot;</span><span class="p">:</span>
                    <span class="n">palette</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;placeholder&quot;</span><span class="p">:</span> <span class="s2">&quot;grey&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;downregulated&quot;</span><span class="p">:</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;upregulated&quot;</span><span class="p">:</span> <span class="s2">&quot;red&quot;</span>
                    <span class="p">}</span>
                    <span class="n">df_vp</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df_vp</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">pthreshold</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span>
                        <span class="n">df_vp</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">FCthreshold</span><span class="p">)),</span> <span class="s1">&#39;legend&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;downregulated&quot;</span>
                    <span class="n">df_vp</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df_vp</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">pthreshold</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span>
                        <span class="n">df_vp</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">FCthreshold</span><span class="p">)),</span> <span class="s1">&#39;legend&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;upregulated&quot;</span>
                <span class="k">elif</span> <span class="n">legend_label</span> <span class="o">==</span> <span class="s2">&quot;analyte_class&quot;</span><span class="p">:</span>
                    <span class="n">color_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">mcolors</span><span class="o">.</span><span class="n">TABLEAU_COLORS</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span>
                        <span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_by</span><span class="p">)]</span>
                    <span class="n">palette</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_by</span><span class="p">,</span> <span class="n">color_keys</span><span class="p">))</span>
                    <span class="n">palette</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;placeholder&quot;</span><span class="p">:</span> <span class="s2">&quot;grey&quot;</span><span class="p">}</span> <span class="o">|</span> <span class="n">palette</span>
                    <span class="n">vp_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms1_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">[</span>
                        <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_filter</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
                    <span class="n">df_vp</span> <span class="o">=</span> <span class="n">df_vp</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">vp_features</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span>
                    <span class="n">vp_indices</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_vp</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">pthreshold</span><span class="p">)</span>
                                  <span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">df_vp</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">FCthreshold</span><span class="p">))</span>
                    <span class="n">df_vp</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">vp_indices</span><span class="p">,</span>
                              <span class="s2">&quot;legend&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vp_features</span><span class="p">[</span><span class="n">vp_indices</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span><span class="o">*</span><span class="mf">1.5</span><span class="p">})</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span> <span class="o">*</span>
                                          <span class="mf">1.5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span><span class="o">*</span><span class="mf">1.5</span><span class="p">))</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">()</span>
                <span class="n">scatter_plt</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_vp</span><span class="p">,</span>
                                              <span class="n">x</span><span class="o">=</span><span class="s2">&quot;intensity&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;legend&quot;</span><span class="p">,</span>
                                              <span class="n">palette</span><span class="o">=</span><span class="n">palette</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
                <span class="n">colors</span> <span class="o">=</span> <span class="n">scatter_plt</span><span class="o">.</span><span class="n">collections</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_facecolors</span><span class="p">()</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">combo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> / </span><span class="si">{</span><span class="n">combo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Log2 FC&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;-Log10 p_value&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">FCthreshold</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                            <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">FCthreshold</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                            <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">pthreshold</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                            <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">feature_label</span> <span class="o">==</span> <span class="s2">&quot;mz&quot;</span><span class="p">:</span>
                    <span class="n">vp_indices</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_vp</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">pthreshold</span><span class="p">)</span>
                                  <span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">df_vp</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">FCthreshold</span><span class="p">))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">repel_labels</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">df_vp</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">][</span><span class="n">vp_indices</span><span class="p">],</span>  <span class="n">df_vp</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">][</span><span class="n">vp_indices</span><span class="p">],</span>
                                     <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span>
                                         <span class="n">df_FC_pair</span><span class="p">[</span><span class="s1">&#39;analyte&#39;</span><span class="p">])]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)[</span><span class="n">vp_indices</span><span class="p">],</span>
                                     <span class="n">colors</span><span class="p">[</span><span class="n">vp_indices</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="n">jitter_amount</span><span class="p">,</span> <span class="n">jitter_factor</span><span class="o">=</span><span class="n">jitter_factor</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">elif</span> <span class="n">feature_label</span> <span class="o">==</span> <span class="s2">&quot;analyte&quot;</span><span class="p">:</span>
                    <span class="n">df_vp_mapping</span> <span class="o">=</span> <span class="n">df_vp</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ms1_df</span><span class="p">[</span><span class="s1">&#39;analyte&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                        <span class="nb">int</span><span class="p">)]</span>
                    <span class="n">vp_indices</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_vp_mapping</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">pthreshold</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span>
                        <span class="nb">abs</span><span class="p">(</span><span class="n">df_vp_mapping</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">FCthreshold</span><span class="p">))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">repel_labels</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">df_vp_mapping</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">][</span><span class="n">vp_indices</span><span class="p">],</span>  <span class="n">df_vp_mapping</span><span class="p">[</span><span class="s1">&#39;p&#39;</span><span class="p">][</span><span class="n">vp_indices</span><span class="p">],</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">ms1_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">analyte_col</span><span class="p">][</span><span class="n">vp_indices</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span>
                                         <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)],</span> <span class="n">colors</span><span class="p">[</span><span class="n">vp_indices</span><span class="p">],</span> <span class="n">k</span><span class="o">=</span><span class="n">jitter_amount</span><span class="p">,</span>
                                     <span class="n">jitter_factor</span><span class="o">=</span><span class="n">jitter_factor</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="k">elif</span> <span class="n">feature_label</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">scatter_plt</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
                <span class="n">filtered_handles</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span> <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                    <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span> <span class="k">if</span> <span class="n">l</span> <span class="o">!=</span> <span class="s1">&#39;placeholder&#39;</span><span class="p">]</span>
                <span class="n">filtered_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">labels</span> <span class="k">if</span> <span class="n">l</span> <span class="o">!=</span> <span class="s1">&#39;placeholder&#39;</span><span class="p">]</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">filtered_handles</span><span class="p">,</span> <span class="n">filtered_labels</span><span class="p">,</span>
                          <span class="n">title_fontproperties</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">})</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/volcano/</span><span class="si">{</span><span class="n">combo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">combo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

                <span class="c1"># vocalno unlabeled</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span><span class="o">*</span><span class="mf">1.5</span><span class="p">})</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span>
                    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span><span class="o">*</span><span class="mf">1.5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span><span class="o">*</span><span class="mf">1.5</span><span class="p">))</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">()</span>
                <span class="n">scatter_plt</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_vp</span><span class="p">,</span>
                                              <span class="n">x</span><span class="o">=</span><span class="s2">&quot;intensity&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;legend&quot;</span><span class="p">,</span>
                                              <span class="n">palette</span><span class="o">=</span><span class="n">palette</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">combo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> / </span><span class="si">{</span><span class="n">combo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Log2 FC&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;-Log10 p_value&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">FCthreshold</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                            <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">FCthreshold</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                            <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">pthreshold</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                            <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
                <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">scatter_plt</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
                <span class="n">filtered_handles</span> <span class="o">=</span> <span class="p">[</span><span class="n">h</span> <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                    <span class="n">handles</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span> <span class="k">if</span> <span class="n">l</span> <span class="o">!=</span> <span class="s1">&#39;placeholder&#39;</span><span class="p">]</span>
                <span class="n">filtered_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">labels</span> <span class="k">if</span> <span class="n">l</span> <span class="o">!=</span> <span class="s1">&#39;placeholder&#39;</span><span class="p">]</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">filtered_handles</span><span class="p">,</span> <span class="n">filtered_labels</span><span class="p">,</span>
                          <span class="n">title_fontproperties</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">})</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/volcano_unlabeled/</span><span class="si">{</span><span class="n">combo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">combo</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished generating volcano plots. </span><span class="se">\n</span><span class="s2">&quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;Volcano plots were stroed in folder </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">get_hm</span><span class="p">:</span>
            <span class="n">df_hm</span> <span class="o">=</span> <span class="n">df_hm</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span>
                <span class="n">index</span><span class="o">=</span><span class="s2">&quot;analyte&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;ROI&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s2">&quot;intensity&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hm_label</span> <span class="o">==</span> <span class="s2">&quot;mz&quot;</span><span class="p">:</span>
                <span class="n">df_hm</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="p">[</span><span class="n">df_hm</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">hm_label</span> <span class="o">==</span> <span class="s2">&quot;analyte&quot;</span><span class="p">:</span>
                <span class="n">ID_col</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span>
                    <span class="s2">&quot;Which column [number] in database to perform filtering? The columns are </span><span class="si">{self.ms1_df.columns}</span><span class="s2">: &quot;</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">df_hm</span> <span class="o">=</span> <span class="n">df_hm</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ms1_df</span><span class="p">[</span><span class="s1">&#39;analyte&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                    <span class="nb">int</span><span class="p">)]</span>
                <span class="n">df_hm</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ms1_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">ID_col</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">col_filter</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">filter_by</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">col_filter</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span>
                        <span class="s2">&quot;Which column [number] in database to perform filtering? The columns are </span><span class="si">{self.ms1_df.columns}</span><span class="s2">: &quot;</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="n">filter_by</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;What are the groups of interest for filtering column </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">col_filter</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> in MS1 database? Separate each group by one space? &quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">filter_by</span> <span class="o">=</span> <span class="n">filter_by</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="n">df_hm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">df_hm</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">df_hm</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span>
                <span class="n">hm_height_factor</span><span class="o">*</span><span class="n">df_hm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">df_hm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">hm_width_factor</span><span class="p">,</span> <span class="n">hm_height_factor</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="n">hm_fontsize</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">hm_label</span> <span class="o">==</span> <span class="s2">&quot;mz&quot;</span><span class="p">:</span>
                <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">],</span>
                              <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="n">hm_wspace</span><span class="p">)</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                <span class="n">hm_plt</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">df_hm</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                                   <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
                <span class="n">hm_plt</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">df_hm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">df_hm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">df_hm</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">]</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                                <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">df_hm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">df_hm</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">df_hm</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">df_hm</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">hm_label</span> <span class="o">==</span> <span class="s2">&quot;analyte&quot;</span><span class="p">:</span>
                <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_by</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">filter_by</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">],</span> <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="n">hm_wspace</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">analyte_class</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_by</span><span class="p">):</span>
                    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="p">])</span>

                    <span class="n">df_hm_subset</span> <span class="o">=</span> <span class="n">df_hm</span><span class="p">[(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ms1_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">col_filter</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">analyte_class</span><span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()]</span>
                    <span class="n">hm_plt</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">df_hm_subset</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                                       <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;coolwarm&#39;</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
                    <span class="n">hm_plt</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">df_hm_subset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">df_hm_subset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">df_hm_subset</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">]</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                                    <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">df_hm_subset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">df_hm_subset</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">df_hm_subset</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">df_hm_subset</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
            <span class="n">cax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">colorbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">hm_plt</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">)</span>
            <span class="n">colorbar</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">colorbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
            <span class="n">cax</span><span class="o">.</span><span class="n">set_position</span><span class="p">([</span><span class="n">cax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">cax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">y0</span> <span class="o">+</span> <span class="n">cax</span><span class="o">.</span><span class="n">get_position</span><span class="p">(</span>
            <span class="p">)</span><span class="o">.</span><span class="n">height</span> <span class="o">*</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">cax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">cax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">height</span> <span class="o">*</span> <span class="mf">0.45</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/volcano/heatmap&quot;</span><span class="p">,</span>
                        <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="DataAnalysis.insitu_clustering">
<a class="viewcode-back" href="../../iMSminer.html#iMSminer.data_analysis.DataAnalysis.insitu_clustering">[docs]</a>
    <span class="k">def</span> <span class="nf">insitu_clustering</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
            <span class="n">perplexity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
            <span class="n">replicate</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">show_ROI</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">show_square</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">ROI_linewidth</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
            <span class="n">ROI_size_divisor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
            <span class="n">insitu_tsne</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        In situ segmentation via k-means clusterin. Groups pixels by similarity in molecular profiles. Outputs in situ visualization of ROIs colored by cluster labels. In situ segmentation with cluster and ROI annotations are visualized in lower-dimensional t-SNE embedding.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        k : int, optional</span>
<span class="sd">            Number of k-means clusters. The default is 10.</span>
<span class="sd">        perplexity : float, optional</span>
<span class="sd">            t-SNE embedding parameter, which influences tightness of embedded neighbors. The default is 15.</span>
<span class="sd">        replicate : int, optional</span>
<span class="sd">            Dataset # of which ion images are rendered. The default is 0.</span>
<span class="sd">        show_ROI : bool, optional</span>
<span class="sd">            Display ROI label above redenred ion image if True. The default is True.</span>
<span class="sd">        show_square : bool, optional</span>
<span class="sd">            Display a green box around selected ROI in rendered ion image if True. The default is False.</span>
<span class="sd">        ROI_line_width : float, optional</span>
<span class="sd">            Controls width of green box surrounding ROIs</span>
<span class="sd">        ROI_size_divisor : float, optional</span>
<span class="sd">            Controls size of ROI labels, where a smaller divisor gives a larger ROI label, by default 8</span>
<span class="sd">        insitu_tsne : bool, optional</span>
<span class="sd">            Renders a RGB in situ representation of 3D t-SNE embedding if `insitu_tsne = True`, by default False</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">resolution</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
            <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Enter spatial resolution of imaging [microns]: &quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/insitu_cluster&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/insitu_cluster&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>
        <span class="c1"># KMeans</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perplexity</span> <span class="o">=</span> <span class="n">perplexity</span>
        <span class="n">truncate_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">columns</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">)</span>
        <span class="n">df_pixel_all_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df_pixel_all_max</span> <span class="o">=</span> <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_pixel_all_max</span><span class="p">[</span><span class="s2">&quot;ROI&quot;</span><span class="p">]</span>
                                                <span class="o">!=</span> <span class="s2">&quot;placeholder&quot;</span><span class="p">]</span>
        <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">div</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>
        <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">div</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>
        <span class="n">df_pixel_all_max</span> <span class="o">=</span> <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">num_iters</span> <span class="o">=</span> <span class="mi">1000</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpu</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Spatial segmentation on CPU. Computing time may be long.&quot;</span><span class="p">)</span>
            <span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span>
            <span class="kn">from</span> <span class="nn">sklearn.manifold</span> <span class="kn">import</span> <span class="n">TSNE</span>

            <span class="c1"># tSNE</span>
            <span class="n">k_means</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="s2">&quot;k-means++&quot;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                             <span class="n">n_init</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="n">num_iters</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">])</span>
            <span class="n">kmeans_labels</span> <span class="o">=</span> <span class="n">k_means</span><span class="o">.</span><span class="n">labels_</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">my_random_state</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">tsne</span> <span class="o">=</span> <span class="n">TSNE</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="n">num_iters</span><span class="p">,</span>
                        <span class="n">perplexity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">perplexity</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">my_random_state</span><span class="p">)</span>
            <span class="n">tsne_embedding</span> <span class="o">=</span> <span class="n">tsne</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span>
                <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">])</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpu</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Spatial segmentation on GPU.&quot;</span><span class="p">)</span>
                <span class="kn">from</span> <span class="nn">cuml</span> <span class="kn">import</span> <span class="n">using_output_type</span>
                <span class="kn">from</span> <span class="nn">cuml.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span>
                <span class="kn">from</span> <span class="nn">cuml.manifold</span> <span class="kn">import</span> <span class="n">TSNE</span>

                <span class="k">with</span> <span class="n">using_output_type</span><span class="p">(</span><span class="s1">&#39;numpy&#39;</span><span class="p">):</span>
                    <span class="n">k_means</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="n">num_iters</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
                        <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">])</span>
                    <span class="n">kmeans_labels</span> <span class="o">=</span> <span class="n">k_means</span><span class="o">.</span><span class="n">labels_</span> <span class="o">+</span> <span class="mi">1</span>

                    <span class="n">my_random_state</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">tsne</span> <span class="o">=</span> <span class="n">TSNE</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="n">num_iters</span><span class="p">,</span>
                                <span class="n">perplexity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">perplexity</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">my_random_state</span><span class="p">,</span>
                                <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
                    <span class="n">tsne_embedding</span> <span class="o">=</span> <span class="n">tsne</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span>
                        <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">])</span>

            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;GPU error. Defaulting to CPU.&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Spatial segmentation on CPU. Computing time may be long.&quot;</span><span class="p">)</span>
                <span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span>
                <span class="kn">from</span> <span class="nn">sklearn.manifold</span> <span class="kn">import</span> <span class="n">TSNE</span>
                <span class="n">k_means</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="s2">&quot;k-means++&quot;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                 <span class="n">n_init</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="n">num_iters</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">])</span>
                <span class="n">kmeans_labels</span> <span class="o">=</span> <span class="n">k_means</span><span class="o">.</span><span class="n">labels_</span> <span class="o">+</span> <span class="mi">1</span>

                <span class="n">my_random_state</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">tsne</span> <span class="o">=</span> <span class="n">TSNE</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="n">num_iters</span><span class="p">,</span>
                            <span class="n">perplexity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">perplexity</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">my_random_state</span><span class="p">)</span>
                <span class="n">tsne_embedding</span> <span class="o">=</span> <span class="n">tsne</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span>
                    <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">])</span>

        <span class="n">df_pixel_all_max</span><span class="p">[</span><span class="s1">&#39;insitu_cluster&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">kmeans_labels</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span><span class="o">*</span><span class="mf">1.5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span><span class="o">*</span><span class="mf">1.5</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span><span class="o">*</span><span class="mf">1.5</span><span class="p">})</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;rainbow&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">kmeans_labels</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">kmeans_labels</span><span class="p">)):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">tsne_embedding</span><span class="p">[</span><span class="n">kmeans_labels</span> <span class="o">==</span> <span class="n">label</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">tsne_embedding</span><span class="p">[</span><span class="n">kmeans_labels</span> <span class="o">==</span> <span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                        <span class="n">c</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Cluster </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span>
            <span class="s2">&quot;In situ segmentation in t-SNE&quot;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;t-SNE 1&quot;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;t-SNE 2&quot;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        <span class="n">legend</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Cluster&#39;</span><span class="p">,</span> <span class="n">title_fontproperties</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">})</span>
        <span class="k">for</span> <span class="n">legend_handle</span> <span class="ow">in</span> <span class="n">legend</span><span class="o">.</span><span class="n">legendHandles</span><span class="p">:</span>
            <span class="n">legend_handle</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/insitu_cluster/kmeans_tsne&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

        <span class="n">categories</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">df_pixel_all_max</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">])</span>
        <span class="n">unique_categories</span> <span class="o">=</span> <span class="n">categories</span><span class="o">.</span><span class="n">categories</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;rainbow&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_categories</span><span class="p">))</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span><span class="o">*</span><span class="mf">1.5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span><span class="o">*</span><span class="mf">1.5</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span><span class="o">*</span><span class="mf">1.5</span><span class="p">})</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">category</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">unique_categories</span><span class="p">):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">df_pixel_all_max</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">category</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">tsne_embedding</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">tsne_embedding</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                        <span class="n">color</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">category</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;In situ segmentation in t-SNE&quot;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;t-SNE 1&quot;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;t-SNE 2&quot;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

        <span class="n">legend</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s1">&#39;ROI&#39;</span><span class="p">,</span> <span class="n">title_fontproperties</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">})</span>
        <span class="k">for</span> <span class="n">legend_handle</span> <span class="ow">in</span> <span class="n">legend</span><span class="o">.</span><span class="n">legendHandles</span><span class="p">:</span>
            <span class="n">legend_handle</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/insitu_cluster/original_space_tsne&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

        <span class="n">insitu_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_pixel_all_max</span><span class="p">[</span><span class="s1">&#39;replicate&#39;</span><span class="p">],</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">kmeans_labels</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;kmeans_label&quot;</span><span class="p">]),</span>
                               <span class="n">df_pixel_all_max</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">insitu_df</span> <span class="o">=</span> <span class="n">insitu_df</span><span class="p">[</span><span class="n">insitu_df</span><span class="p">[</span><span class="s1">&#39;replicate&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">replicate</span><span class="p">]</span>
        <span class="n">insitu_df</span> <span class="o">=</span> <span class="n">insitu_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;replicate&#39;</span><span class="p">])</span>

        <span class="n">insitu_image</span> <span class="o">=</span> <span class="n">make_image_1c</span><span class="p">(</span>
            <span class="n">data_2darray</span><span class="o">=</span><span class="n">insitu_df</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">remap_coord</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">insitu_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_equal</span><span class="p">(</span><span class="n">insitu_image</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">ROI_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ROI_info</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ROI_info</span><span class="p">[</span><span class="s2">&quot;replicate&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">replicate</span><span class="p">]</span>
        <span class="n">ROI_info</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">show_ROI</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">show_square</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">width_ratios</span> <span class="o">=</span> <span class="p">(</span><span class="n">ROI_info</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">ROI_info</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">]</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">width_ratios</span> <span class="o">/=</span> <span class="nb">max</span><span class="p">(</span><span class="n">width_ratios</span><span class="p">)</span>
        <span class="n">width_ratios</span> <span class="o">=</span> <span class="n">width_ratios</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;dark_background&#39;</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="mi">20</span><span class="p">})</span>
        <span class="n">ROI_label_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="n">ROI_info</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">ROI_info</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">ROI_size_divisor</span>
        <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ROI_info</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                      <span class="n">width_ratios</span><span class="o">=</span><span class="n">width_ratios</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">],</span> <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ax_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ROI_info</span><span class="p">)):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax_index</span><span class="p">])</span>
            <span class="n">ROI</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ROI_info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ax_index</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
            <span class="n">start_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ROI</span><span class="o">.</span><span class="n">columns</span> <span class="o">==</span> <span class="s2">&quot;bottom&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">truncate_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ROI_info</span><span class="o">.</span><span class="n">columns</span> <span class="o">==</span> <span class="s2">&quot;right&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">squares</span> <span class="o">=</span> <span class="n">ROI</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">start_col</span><span class="p">:</span><span class="n">truncate_col</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

            <span class="n">im_ROI</span> <span class="o">=</span> <span class="n">insitu_image</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="nb">int</span><span class="p">(</span><span class="n">squares</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]):(</span><span class="nb">int</span><span class="p">(</span><span class="n">squares</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
                                     <span class="nb">int</span><span class="p">(</span><span class="n">squares</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]):(</span><span class="nb">int</span><span class="p">(</span><span class="n">squares</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
            <span class="n">kmeans_insitu</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
                <span class="n">im_ROI</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;rainbow&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">kmeans_labels</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">square</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">squares</span><span class="p">):</span>
                <span class="n">bottom</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="n">square</span>
                <span class="n">top</span> <span class="o">-=</span> <span class="n">bottom</span>
                <span class="n">bottom</span> <span class="o">-=</span> <span class="n">bottom</span>
                <span class="n">right</span> <span class="o">-=</span> <span class="n">left</span>
                <span class="n">left</span> <span class="o">-=</span> <span class="n">left</span>
                <span class="n">x_coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">left</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">left</span><span class="p">]</span>
                <span class="n">y_coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">bottom</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">bottom</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">show_square</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_coords</span><span class="p">,</span> <span class="n">y_coords</span><span class="p">,</span> <span class="s1">&#39;g-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">show_ROI</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">right</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">bottom</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ROI</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                             <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">ROI_label_size</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">cax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">colorbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">kmeans_insitu</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">)</span>
        <span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">kmeans_labels</span><span class="p">)</span>
        <span class="n">colorbar</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">min_val</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_val</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">cax</span><span class="o">.</span><span class="n">set_position</span><span class="p">([</span><span class="n">cax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">cax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">y0</span> <span class="o">+</span> <span class="n">cax</span><span class="o">.</span><span class="n">get_position</span><span class="p">(</span>
        <span class="p">)</span><span class="o">.</span><span class="n">height</span> <span class="o">*</span> <span class="mf">0.25</span><span class="p">,</span> <span class="n">cax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">cax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">height</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">])</span>
        <span class="n">cax_pos</span> <span class="o">=</span> <span class="n">cax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span>
        <span class="n">line_y</span> <span class="o">=</span> <span class="n">cax_pos</span><span class="o">.</span><span class="n">y1</span> <span class="o">+</span> <span class="mf">0.05</span>
        <span class="n">line_x_start</span> <span class="o">=</span> <span class="n">cax_pos</span><span class="o">.</span><span class="n">x0</span>
        <span class="n">line_x_end</span> <span class="o">=</span> <span class="n">cax_pos</span><span class="o">.</span><span class="n">x1</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">Line2D</span><span class="p">([</span><span class="n">line_x_start</span><span class="p">,</span> <span class="n">line_x_end</span><span class="p">],</span> <span class="p">[</span><span class="n">line_y</span><span class="p">,</span> <span class="n">line_y</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span>
                      <span class="n">transform</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">transFigure</span><span class="p">,</span> <span class="n">clip_on</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">ROI_linewidth</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">resolution_plt</span> <span class="o">=</span> <span class="n">resolution</span> <span class="o">*</span> \
            <span class="nb">max</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ROI_info</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">ROI_info</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">line_x_end</span><span class="o">-</span><span class="n">line_x_start</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ROI_num</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="n">line_x_start</span> <span class="o">+</span> <span class="n">line_x_end</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">line_y</span> <span class="o">+</span> <span class="mf">0.02</span><span class="p">,</span>
                 <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">resolution_plt</span><span class="si">:</span><span class="s1">.0f</span><span class="si">}</span><span class="s1"> $\mu$m&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">ROI_label_size</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/insitu_cluster/kmeans_insitu_image&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span></div>


<div class="viewcode-block" id="DataAnalysis.optimize_insitu_clustering">
<a class="viewcode-back" href="../../iMSminer.html#iMSminer.data_analysis.DataAnalysis.optimize_insitu_clustering">[docs]</a>
    <span class="k">def</span> <span class="nf">optimize_insitu_clustering</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">k_max</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        In situ segmentation via k-means clusterin. Groups pixels by similarity in molecular profiles. Outputs in situ visualization of ROIs colored by cluster labels. In situ segmentation with cluster and ROI annotations are visualized in lower-dimensional t-SNE embedding.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        k_max : int, optional</span>
<span class="sd">            Maximum number of clusters for cluster validity evaluation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/insitu_cluster&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/insitu_cluster&quot;</span><span class="p">)</span>
        <span class="n">score_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">k_max</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

        <span class="n">truncate_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">columns</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">)</span>
        <span class="n">df_pixel_all_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df_pixel_all_max</span> <span class="o">=</span> <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_pixel_all_max</span><span class="p">[</span><span class="s2">&quot;ROI&quot;</span><span class="p">]</span>
                                                <span class="o">!=</span> <span class="s2">&quot;placeholder&quot;</span><span class="p">]</span>
        <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">div</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>
        <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">div</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
        <span class="p">)</span>
        <span class="n">df_pixel_all_max</span> <span class="o">=</span> <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">num_iters</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">k_max</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpu</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;In situ clustering on CPU. Computing time may be long.&quot;</span><span class="p">)</span>
                <span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span>
                <span class="n">k_means</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="s2">&quot;k-means++&quot;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                 <span class="n">n_init</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="n">num_iters</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">])</span>
                <span class="n">kmeans_labels</span> <span class="o">=</span> <span class="n">k_means</span><span class="o">.</span><span class="n">labels_</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpu</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Image clustering on GPU.&quot;</span><span class="p">)</span>
                    <span class="kn">from</span> <span class="nn">cuml</span> <span class="kn">import</span> <span class="n">using_output_type</span>
                    <span class="kn">from</span> <span class="nn">cuml.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span>
                    <span class="k">with</span> <span class="n">using_output_type</span><span class="p">(</span><span class="s1">&#39;numpy&#39;</span><span class="p">):</span>

                        <span class="n">k_means</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="n">num_iters</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
                            <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">])</span>
                        <span class="n">kmeans_labels</span> <span class="o">=</span> <span class="n">k_means</span><span class="o">.</span><span class="n">labels_</span> <span class="o">+</span> <span class="mi">1</span>

                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;GPU error. Defaulting to CPU.&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Image clustering on CPU. Computing time may be long.&quot;</span><span class="p">)</span>
                    <span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span>
                    <span class="n">k_means</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="s2">&quot;k-means++&quot;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                     <span class="n">n_init</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="n">num_iters</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">])</span>
                    <span class="n">kmeans_labels</span> <span class="o">=</span> <span class="n">k_means</span><span class="o">.</span><span class="n">labels_</span> <span class="o">+</span> <span class="mi">1</span>

                <span class="n">score_array</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">davies_bouldin_score</span><span class="p">(</span>
                    <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">],</span> <span class="n">kmeans_labels</span><span class="p">)</span>
                <span class="n">score_array</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">calinski_harabasz_score</span><span class="p">(</span>
                    <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">],</span> <span class="n">kmeans_labels</span><span class="p">)</span>
                <span class="n">score_array</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">silhouette_score</span><span class="p">(</span>
                    <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">],</span> <span class="n">k_means</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span><span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]))</span>
                <span class="n">score_array</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">k_means</span><span class="o">.</span><span class="n">inertia_</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>
        <span class="n">categories</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;DB&quot;</span><span class="p">,</span> <span class="s2">&quot;CH&quot;</span><span class="p">,</span> <span class="s2">&quot;Silhouette&quot;</span><span class="p">,</span> <span class="s2">&quot;Elbow&quot;</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">22</span><span class="p">})</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">]</span>
        <span class="n">normalized_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">score_array</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">score_array</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">x_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">k_max</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">category</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">categories</span><span class="p">,</span> <span class="n">colors</span><span class="p">)):</span>
            <span class="n">y_values</span> <span class="o">=</span> <span class="n">normalized_scores</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="n">y_values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">category</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="n">y_values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Number of clusters&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Max-Normalized Scores&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Score&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;small&quot;</span><span class="p">,</span>
                   <span class="n">title_fontproperties</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">})</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/insitu_cluster/insitu_clustering_optimization_plot.png&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="DataAnalysis.image_clustering">
<a class="viewcode-back" href="../../iMSminer.html#iMSminer.data_analysis.DataAnalysis.image_clustering">[docs]</a>
    <span class="k">def</span> <span class="nf">image_clustering</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
            <span class="n">perplexity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
            <span class="n">replicate</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">show_ROI</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">show_square</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
            <span class="n">color_scheme</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;inferno&quot;</span><span class="p">,</span>
            <span class="n">insitu_tsne</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">insitu_perplexity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
            <span class="n">zoom</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
            <span class="n">quantile</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
            <span class="n">img_plot_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;plot_ROI&quot;</span><span class="p">,</span>
            <span class="n">feature_label</span><span class="o">=</span><span class="s2">&quot;mz&quot;</span><span class="p">,</span>
            <span class="n">jitter_amount</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">jitter_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
            <span class="n">font_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
            <span class="n">ROI_linewidth</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
            <span class="n">ROI_size_divisor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Group ion images by spatial co-localization. Outputs in situ and box plot visualizations of mean ion image for each cluster. Clustering analysis and in situ mapping of clusters are summarized in lower-dimensional t -SNE embedding.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        k : int, optional</span>
<span class="sd">            Number of k-means clusters. The default is 10.</span>
<span class="sd">        perplexity : float, optional</span>
<span class="sd">            t-SNE embedding parameter, which influences tightness of embedded neighbors. The default is 5.</span>
<span class="sd">        replicate : int, optional</span>
<span class="sd">            Dataset # of which ion images are rendered. The default is 0.</span>
<span class="sd">        show_ROI : bool, optional</span>
<span class="sd">            Display ROI label above redenred ion image if True. The default is True.</span>
<span class="sd">        show_square : bool, optional</span>
<span class="sd">            Display a green box around selected ROI in rendered ion image if True. The default is False.</span>
<span class="sd">        color_scheme : str, optional</span>
<span class="sd">            False-color scheme for ion image visualization. The default is &quot;inferno&quot;. A list of color schemes are available here: https://matplotlib.org/stable/users/explain/colors/colormaps.html</span>
<span class="sd">        zoom : float, optional</span>
<span class="sd">            Relative size of ion images in t-SNE embedding to the embedding. The default is 0.1.</span>
<span class="sd">        quantile : TYPE, optional</span>
<span class="sd">            Maximum intensity quantile cutoff for ion image visualization. The default is 100.</span>
<span class="sd">        img_plot_method: str, optional</span>
<span class="sd">            Controls layout of rendered in situ heatmaps</span>
<span class="sd">            Method `plot_img` retains all coordinates from imaging mass spectrometry experiment</span>
<span class="sd">            Method `plot_ROI` renders heatmaps of ROIs </span>
<span class="sd">        jitter_amount : float, optional</span>
<span class="sd">            Controls placement of feature labels in t-SNE embedding of ion images, by default 2</span>
<span class="sd">        jitter_factor : float, optional</span>
<span class="sd">            Controls the repulsiveness of neighboring feature labels in t-SNE embedding of ion images, by deafult 100</span>
<span class="sd">        font_size : float, optional</span>
<span class="sd">            Font size of feature labels in volcano plot, by default 15</span>
<span class="sd">        ROI_line_width : float, optional</span>
<span class="sd">            Controls width of green box surrounding ROIs, by default 3</span>
<span class="sd">        ROI_size_divisor : float, optional</span>
<span class="sd">            Controls size of ROI labels, where a smaller divisor gives a larger ROI label, by default 8</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/image_cluster&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/image_cluster&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">feature_label</span> <span class="o">==</span> <span class="s2">&quot;analyte&quot;</span><span class="p">:</span>
            <span class="n">analyte_col</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Enter column number that corresponds to analyte IDs. The columns are </span><span class="se">\n</span><span class="s2">&quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ms1_df</span><span class="o">.</span><span class="n">columns</span><span class="si">}</span><span class="s2">: &quot;</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>
        <span class="n">resolution</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
            <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Enter spatial resolution of imaging [microns]: &quot;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perplexity</span> <span class="o">=</span> <span class="n">perplexity</span>

        <span class="n">truncate_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">columns</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">)</span>
        <span class="n">df_pixel_all_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df_pixel_all_max</span> <span class="o">=</span> <span class="n">df_pixel_all_max</span><span class="p">[</span><span class="n">df_pixel_all_max</span><span class="p">[</span><span class="s2">&quot;ROI&quot;</span><span class="p">]</span>
                                            <span class="o">!=</span> <span class="s2">&quot;placeholder&quot;</span><span class="p">]</span>
        <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">div</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">num_iters</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpu</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Image clustering on CPU. Computing time may be long.&quot;</span><span class="p">)</span>
            <span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span>
            <span class="kn">from</span> <span class="nn">sklearn.manifold</span> <span class="kn">import</span> <span class="n">TSNE</span>
            <span class="n">k_means</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="s2">&quot;k-means++&quot;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                             <span class="n">n_init</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="n">num_iters</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="n">kmeans_labels</span> <span class="o">=</span> <span class="n">k_means</span><span class="o">.</span><span class="n">labels_</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="n">my_random_state</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">tsne</span> <span class="o">=</span> <span class="n">TSNE</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="n">num_iters</span><span class="p">,</span>
                        <span class="n">perplexity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">perplexity</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">my_random_state</span><span class="p">)</span>
            <span class="n">tsne_embedding</span> <span class="o">=</span> <span class="n">tsne</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span>
                <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpu</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Image clustering on GPU.&quot;</span><span class="p">)</span>
                <span class="kn">from</span> <span class="nn">cuml</span> <span class="kn">import</span> <span class="n">using_output_type</span>
                <span class="kn">from</span> <span class="nn">cuml.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span>
                <span class="kn">from</span> <span class="nn">cuml.manifold</span> <span class="kn">import</span> <span class="n">TSNE</span>
                <span class="k">with</span> <span class="n">using_output_type</span><span class="p">(</span><span class="s1">&#39;numpy&#39;</span><span class="p">):</span>

                    <span class="n">k_means</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="n">num_iters</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
                        <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                    <span class="n">kmeans_labels</span> <span class="o">=</span> <span class="n">k_means</span><span class="o">.</span><span class="n">labels_</span> <span class="o">+</span> <span class="mi">1</span>

                    <span class="n">my_random_state</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">tsne</span> <span class="o">=</span> <span class="n">TSNE</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="n">num_iters</span><span class="p">,</span>
                                <span class="n">perplexity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">perplexity</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">my_random_state</span><span class="p">,</span>
                                <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span>
                    <span class="n">tsne_embedding</span> <span class="o">=</span> <span class="n">tsne</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span>
                        <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;GPU error. Defaulting to CPU.&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Image clustering on CPU. Computing time may be long.&quot;</span><span class="p">)</span>
                <span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span>
                <span class="kn">from</span> <span class="nn">sklearn.manifold</span> <span class="kn">import</span> <span class="n">TSNE</span>
                <span class="n">k_means</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="s2">&quot;k-means++&quot;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                 <span class="n">n_init</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="n">num_iters</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                <span class="n">kmeans_labels</span> <span class="o">=</span> <span class="n">k_means</span><span class="o">.</span><span class="n">labels_</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">my_random_state</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">tsne</span> <span class="o">=</span> <span class="n">TSNE</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="n">num_iters</span><span class="p">,</span>
                            <span class="n">perplexity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">perplexity</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">my_random_state</span><span class="p">)</span>
                <span class="n">tsne_embedding</span> <span class="o">=</span> <span class="n">tsne</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span>
                    <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="n">image_cluster_label</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">kmeans_labels</span><span class="p">)</span>
        <span class="n">image_cluster_label</span> <span class="o">=</span> <span class="n">image_cluster_label</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">image_cluster_label</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="s1">&#39;analyte&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;cluster&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">image_df</span> <span class="o">=</span> <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">,</span> <span class="s1">&#39;replicate&#39;</span><span class="p">,</span> <span class="s1">&#39;ROI_num&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">cluster_mean_df</span> <span class="o">=</span> <span class="n">image_df</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">]</span>
        <span class="n">image_cluster_all</span> <span class="o">=</span> <span class="n">df_pixel_all_max</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">cluster_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>  <span class="c1"># loop through clusters</span>
            <span class="n">cluster_df</span> <span class="o">=</span> <span class="n">image_df</span><span class="p">[</span><span class="n">image_cluster_label</span><span class="p">[</span><span class="n">image_cluster_label</span><span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">]</span>
                                                      <span class="o">==</span> <span class="n">cluster_index</span><span class="p">][</span><span class="s1">&#39;analyte&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">cluster_df</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cluster_index</span><span class="p">)</span>
            <span class="n">cluster_mean_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">cluster_mean_df</span><span class="p">,</span> <span class="n">cluster_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">image_cluster</span> <span class="o">=</span> <span class="n">df_pixel_all_max</span><span class="p">[</span><span class="n">image_cluster_label</span><span class="p">[</span><span class="n">image_cluster_label</span><span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">]</span>
                                                                 <span class="o">==</span> <span class="n">cluster_index</span><span class="p">][</span><span class="s1">&#39;analyte&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">image_cluster</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cluster_index</span><span class="p">)</span>
            <span class="n">image_cluster_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                <span class="p">[</span><span class="n">image_cluster_all</span><span class="p">,</span> <span class="n">image_cluster</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">cluster_mean_df</span> <span class="o">=</span> <span class="n">cluster_mean_df</span><span class="p">[</span><span class="n">cluster_mean_df</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">]</span>
                                          <span class="o">!=</span> <span class="s2">&quot;placeholder&quot;</span><span class="p">]</span>

        <span class="n">image_cluster_all</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df_pixel_all_max</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]]</span>
        <span class="n">image_cluster_all</span> <span class="o">=</span> <span class="n">image_cluster_all</span><span class="p">[</span><span class="n">df_pixel_all_max</span><span class="p">[</span><span class="s1">&#39;replicate&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">replicate</span><span class="p">]</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span><span class="o">*</span><span class="mf">1.5</span><span class="p">})</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span><span class="o">*</span><span class="mf">1.5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span><span class="o">*</span><span class="mf">1.5</span><span class="p">))</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">()</span>
        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;rainbow&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">kmeans_labels</span><span class="p">)))</span>
        <span class="n">label_to_color</span> <span class="o">=</span> <span class="p">{</span><span class="n">label</span><span class="p">:</span> <span class="n">cmap</span><span class="p">(</span>
            <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">kmeans_labels</span><span class="p">))}</span>
        <span class="n">flat_colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">label_to_color</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">kmeans_labels</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">kmeans_labels</span><span class="p">)):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">tsne_embedding</span><span class="p">[</span><span class="n">kmeans_labels</span> <span class="o">==</span> <span class="n">label</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">tsne_embedding</span><span class="p">[</span><span class="n">kmeans_labels</span> <span class="o">==</span> <span class="n">label</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                       <span class="n">c</span><span class="o">=</span><span class="n">cmap</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
                       <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Cluster </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">feature_label</span> <span class="o">==</span> <span class="s2">&quot;mz&quot;</span><span class="p">:</span>
            <span class="n">repel_labels</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">tsne_embedding</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">tsne_embedding</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="mi">1</span><span class="p">),</span> <span class="n">flat_colors</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">jitter_amount</span><span class="p">,</span> <span class="n">jitter_factor</span><span class="o">=</span><span class="n">jitter_factor</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">feature_label</span> <span class="o">==</span> <span class="s2">&quot;analyte&quot;</span><span class="p">:</span>
            <span class="n">ms1_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ms1_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">[</span>
                <span class="mi">0</span><span class="p">,</span> <span class="n">analyte_col</span><span class="p">]]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="n">tsne_mapping</span> <span class="o">=</span> <span class="n">tsne_embedding</span><span class="p">[</span><span class="n">ms1_features</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),]</span>
            <span class="n">repel_labels</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">tsne_mapping</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">tsne_mapping</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                         <span class="n">ms1_features</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">flat_colors</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">jitter_amount</span><span class="p">,</span>
                         <span class="n">jitter_factor</span><span class="o">=</span><span class="n">jitter_factor</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="n">font_size</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">feature_label</span> <span class="o">==</span> <span class="s2">&quot;none&quot;</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Method for `feature_label` not found. Defaults to no labeling.&quot;</span><span class="p">)</span>
            <span class="k">pass</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span>
            <span class="s2">&quot;Image clusters in t-SNE&quot;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;t-SNE 1&quot;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;t-SNE 2&quot;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        <span class="n">legend</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Cluster&#39;</span><span class="p">,</span> <span class="n">title_fontproperties</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">})</span>
        <span class="k">for</span> <span class="n">legend_handle</span> <span class="ow">in</span> <span class="n">legend</span><span class="o">.</span><span class="n">legendHandles</span><span class="p">:</span>
            <span class="n">legend_handle</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/image_cluster/image_kmeans_tsne&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="n">truncate_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">columns</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="n">insitu_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_pixel_all_max</span><span class="p">[</span><span class="s1">&#39;replicate&#39;</span><span class="p">],</span>
                               <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]],</span>
                              <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">insitu_df</span> <span class="o">=</span> <span class="n">insitu_df</span><span class="p">[</span><span class="n">insitu_df</span><span class="p">[</span><span class="s1">&#39;replicate&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">replicate</span><span class="p">]</span>
        <span class="n">insitu_df</span> <span class="o">=</span> <span class="n">insitu_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;replicate&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jit</span><span class="p">:</span>
            <span class="n">insitu_2darray</span> <span class="o">=</span> <span class="n">insitu_df</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="n">img_array_1c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">insitu_2darray</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">insitu_2darray</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]))</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                                     <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">insitu_2darray</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]))</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">insitu_image</span> <span class="o">=</span> <span class="n">make_image_1c_njit</span><span class="p">(</span>
                <span class="n">data_2darray</span><span class="o">=</span><span class="n">insitu_2darray</span><span class="p">,</span> <span class="n">img_array_1c</span><span class="o">=</span><span class="n">img_array_1c</span><span class="p">,</span> <span class="n">remap_coord</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">insitu_2darray</span><span class="p">,</span> <span class="n">img_array_1c</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">insitu_image</span> <span class="o">=</span> <span class="n">make_image_1c</span><span class="p">(</span>
                <span class="n">data_2darray</span><span class="o">=</span><span class="n">insitu_df</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">remap_coord</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">img_plot_method</span> <span class="o">==</span> <span class="s2">&quot;plot_img&quot;</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span><span class="o">*</span><span class="mf">1.5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span><span class="o">*</span><span class="mf">1.5</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span><span class="o">*</span><span class="mf">1.5</span><span class="p">})</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">tsne_embedding</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">im</span><span class="p">,</span> <span class="n">xy</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">insitu_image</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">tsne_embedding</span><span class="p">):</span>
                <span class="n">q_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">quantile</span><span class="p">)</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">q_max</span><span class="p">)</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">plot_image_at_point</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">xy</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="n">zoom</span><span class="p">,</span> <span class="n">color_scheme</span><span class="o">=</span><span class="s2">&quot;inferno&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Image clusters in t-SNE&quot;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;t-SNE 1&quot;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;t-SNE 2&quot;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/image_cluster/image_insitu_tsne&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">img_plot_method</span> <span class="o">==</span> <span class="s2">&quot;plot_ROI&quot;</span><span class="p">:</span>
            <span class="n">img_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">ROI_max</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ROI_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ROI_info</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ROI_info</span><span class="p">[</span><span class="s2">&quot;replicate&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">replicate</span><span class="p">]</span>
            <span class="n">ROI_info</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">show_ROI</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">show_square</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">color_scheme</span> <span class="o">=</span> <span class="s2">&quot;inferno&quot;</span>
            <span class="n">width_ratios</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">ROI_info</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">ROI_info</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">width_ratios</span> <span class="o">/=</span> <span class="nb">max</span><span class="p">(</span><span class="n">width_ratios</span><span class="p">)</span>
            <span class="n">width_ratios</span> <span class="o">=</span> <span class="n">width_ratios</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
                <span class="n">df_pixel_all_max</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="mi">20</span><span class="p">})</span>
            <span class="n">ROI_label_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="n">ROI_info</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">ROI_info</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">ROI_size_divisor</span>
            <span class="n">truncate_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ROI_info</span><span class="o">.</span><span class="n">columns</span> <span class="o">==</span> <span class="s2">&quot;right&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">analyte</span><span class="p">,</span> <span class="n">im</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">insitu_image</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]):</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;dark_background&#39;</span><span class="p">)</span>
                <span class="n">q_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">quantile</span><span class="p">)</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">q_max</span><span class="p">)</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
                <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span>
                    <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ROI_info</span><span class="p">),</span> <span class="n">width_ratios</span><span class="o">=</span><span class="n">width_ratios</span><span class="p">,</span> <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">ax_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ROI_info</span><span class="p">)):</span>
                    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax_index</span><span class="p">])</span>
                    <span class="n">ROI</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ROI_info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ax_index</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
                    <span class="n">start_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ROI</span><span class="o">.</span><span class="n">columns</span> <span class="o">==</span> <span class="s2">&quot;bottom&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">squares</span> <span class="o">=</span> <span class="n">ROI</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">start_col</span><span class="p">:</span><span class="n">truncate_col</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

                    <span class="n">im_ROI</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">squares</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]):(</span><span class="nb">int</span><span class="p">(</span><span class="n">squares</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
                                <span class="nb">int</span><span class="p">(</span><span class="n">squares</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]):(</span><span class="nb">int</span><span class="p">(</span><span class="n">squares</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">im_ROI</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ROI_max</span><span class="p">:</span>
                        <span class="n">ROI_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">im_ROI</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im_ROI</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">color_scheme</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">square</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">squares</span><span class="p">):</span>
                        <span class="n">bottom</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="n">square</span>
                        <span class="n">top</span> <span class="o">-=</span> <span class="n">bottom</span>
                        <span class="n">bottom</span> <span class="o">-=</span> <span class="n">bottom</span>
                        <span class="n">right</span> <span class="o">-=</span> <span class="n">left</span>
                        <span class="n">left</span> <span class="o">-=</span> <span class="n">left</span>
                        <span class="n">x_coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">left</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">left</span><span class="p">]</span>
                        <span class="n">y_coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">bottom</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">bottom</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">show_square</span><span class="p">:</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_coords</span><span class="p">,</span> <span class="n">y_coords</span><span class="p">,</span> <span class="s1">&#39;g-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">show_ROI</span><span class="p">:</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">right</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">bottom</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ROI</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                     <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">ROI_label_size</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

                <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">img_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">buffer_rgba</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
                <span class="n">img_array</span> <span class="o">=</span> <span class="n">img_array</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">get_width_height</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span><span class="p">,))</span>
                <span class="n">img_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">img_array</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span><span class="o">*</span><span class="mf">1.5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span><span class="o">*</span><span class="mf">1.5</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">fig_ratio</span><span class="o">*</span><span class="mf">1.5</span><span class="p">})</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">tsne_embedding</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">im</span><span class="p">,</span> <span class="n">xy</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">img_list</span><span class="p">,</span> <span class="n">tsne_embedding</span><span class="p">):</span>
                <span class="n">plot_image_at_point</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">xy</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="n">zoom</span><span class="p">,</span> <span class="n">color_scheme</span><span class="o">=</span><span class="s2">&quot;inferno&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Image clusters in t-SNE&quot;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;t-SNE 1&quot;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;t-SNE 2&quot;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/image_cluster/image_insitu_tsne&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>
        <span class="n">image_cluster_df_long</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">cluster_mean_df</span><span class="p">,</span> <span class="n">id_vars</span><span class="o">=</span><span class="p">[</span>
                                        <span class="s1">&#39;ROI&#39;</span><span class="p">],</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;cluster&#39;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;intensity&#39;</span><span class="p">)</span>
        <span class="n">image_cluster_df_long</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">image_cluster_df_long</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">div</span><span class="p">(</span>
            <span class="n">image_cluster_df_long</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;cluster&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s1">&#39;max&#39;</span><span class="p">)[</span><span class="s1">&#39;intensity&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">image_cluster_df_long</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">ROI</span> <span class="o">=</span> <span class="n">image_cluster_df_long</span><span class="p">[</span><span class="s2">&quot;ROI&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">image_cluster_df_long</span><span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
                <span class="n">image_cluster_df_cluster</span> <span class="o">=</span> <span class="n">image_cluster_df_long</span><span class="p">[</span>
                    <span class="n">image_cluster_df_long</span><span class="p">[</span><span class="s1">&#39;cluster&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">cluster</span><span class="p">]</span>
                <span class="n">pvalue</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">sm</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">anova_lm</span><span class="p">(</span>
                        <span class="n">ols</span><span class="p">(</span><span class="s1">&#39;intensity ~ C(ROI)&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">image_cluster_df_cluster</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                            <span class="p">(</span><span class="n">image_cluster_df_cluster</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">combo</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">|</span>
                            <span class="p">(</span><span class="n">image_cluster_df_cluster</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">combo</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                            <span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">,</span> <span class="s1">&#39;intensity&#39;</span><span class="p">]]</span>
                            <span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(),</span>
                        <span class="n">typ</span><span class="o">=</span><span class="mi">1</span>
                    <span class="p">)[</span><span class="s1">&#39;PR(&gt;F)&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">combo</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">combinations</span><span class="p">(</span><span class="n">ROI</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="mi">2</span><span class="p">))</span>
                <span class="p">]</span>
                <span class="n">model_pairs</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">combo</span>
                    <span class="k">for</span> <span class="n">combo</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">combinations</span><span class="p">(</span><span class="n">ROI</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="mi">2</span><span class="p">))</span>
                <span class="p">]</span>

                <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span>
                    <span class="p">(</span><span class="mi">10</span><span class="o">+</span><span class="n">math</span><span class="o">.</span><span class="n">comb</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ROI_num</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">7</span><span class="o">+</span><span class="n">math</span><span class="o">.</span><span class="n">comb</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ROI_num</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">10</span><span class="o">+</span><span class="n">math</span><span class="o">.</span><span class="n">comb</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ROI_num</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">)})</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">()</span>
                <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;ROI&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;intensity&quot;</span><span class="p">,</span>
                            <span class="n">data</span><span class="o">=</span><span class="n">image_cluster_df_cluster</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
                <span class="n">sns</span><span class="o">.</span><span class="n">stripplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;ROI&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;intensity&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">image_cluster_df_cluster</span><span class="p">,</span>
                              <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">jitter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">annotator</span> <span class="o">=</span> <span class="n">Annotator</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">model_pairs</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;ROI&quot;</span><span class="p">,</span>
                                      <span class="n">y</span><span class="o">=</span><span class="s2">&quot;intensity&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">image_cluster_df_cluster</span><span class="p">)</span>
                <span class="n">formatted_pvalues</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">significance</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pvalue</span><span class="p">]</span>
                <span class="n">annotator</span><span class="o">.</span><span class="n">set_custom_annotations</span><span class="p">(</span><span class="n">formatted_pvalues</span><span class="p">)</span>
                <span class="n">annotator</span><span class="o">.</span><span class="n">annotate</span><span class="p">()</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Mean image of cluster </span><span class="si">{</span><span class="n">cluster</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;ROI&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Mean Intensity&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/image_cluster/boxplot_cluster</span><span class="si">{</span><span class="n">cluster</span><span class="si">}</span><span class="s2">.jpg&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

        <span class="n">image_cluster_all</span> <span class="o">=</span> <span class="n">image_cluster_all</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ROI&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jit</span><span class="p">:</span>
            <span class="n">insitu_2darray</span> <span class="o">=</span> <span class="n">image_cluster_all</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="n">img_array_1c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">insitu_2darray</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">insitu_2darray</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]))</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                                     <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">insitu_2darray</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]))</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">insitu_image</span> <span class="o">=</span> <span class="n">make_image_1c_njit</span><span class="p">(</span>
                <span class="n">data_2darray</span><span class="o">=</span><span class="n">insitu_2darray</span><span class="p">,</span> <span class="n">img_array_1c</span><span class="o">=</span><span class="n">img_array_1c</span><span class="p">,</span> <span class="n">remap_coord</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">insitu_2darray</span><span class="p">,</span> <span class="n">img_array_1c</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">insitu_image</span> <span class="o">=</span> <span class="n">make_image_1c</span><span class="p">(</span><span class="n">data_2darray</span><span class="o">=</span><span class="n">image_cluster_all</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span>
                                         <span class="n">remap_coord</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">max_normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">ROI_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ROI_info</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ROI_info</span><span class="p">[</span><span class="s2">&quot;replicate&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">replicate</span><span class="p">]</span>
        <span class="n">ROI_info</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">img_plot_method</span> <span class="o">==</span> <span class="s2">&quot;plot_img&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">analyte</span><span class="p">,</span> <span class="n">im</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">insitu_image</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]):</span>
                <span class="n">q_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">quantile</span><span class="p">)</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">q_max</span><span class="p">)</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;dark_background&#39;</span><span class="p">)</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
                    <span class="n">insitu_df</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
                    <span class="n">df_pixel_all_max</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">})</span>
                <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">df_pixel_all_max</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
                    <span class="c1"># image and legend grids</span>
                    <span class="n">df_pixel_all_max</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="mi">25</span><span class="p">],</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
                <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">im_plot</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">color_scheme</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">draw_ROI</span><span class="p">(</span><span class="n">ROI_info</span><span class="p">,</span> <span class="n">show_ROI</span><span class="o">=</span><span class="n">show_ROI</span><span class="p">,</span> <span class="n">show_square</span><span class="o">=</span><span class="n">show_square</span><span class="p">,</span>
                         <span class="n">linewidth</span><span class="o">=</span><span class="n">ROI_linewidth</span><span class="p">,</span> <span class="n">ROI_size_divisor</span><span class="o">=</span><span class="n">ROI_size_divisor</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean image of cluster </span><span class="si">{</span><span class="n">analyte</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">colorbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im_plot</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
                <span class="n">colorbar</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">colorbar</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">quantile</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/image_cluster/mean_image_cluster</span><span class="si">{</span><span class="n">analyte</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>
            <span class="k">del</span> <span class="n">image_cluster_all</span>
        <span class="k">elif</span> <span class="n">img_plot_method</span> <span class="o">==</span> <span class="s2">&quot;plot_ROI&quot;</span><span class="p">:</span>
            <span class="n">show_ROI</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">show_square</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">color_scheme</span> <span class="o">=</span> <span class="s2">&quot;inferno&quot;</span>
            <span class="n">width_ratios</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">ROI_info</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">ROI_info</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">width_ratios</span> <span class="o">/=</span> <span class="nb">max</span><span class="p">(</span><span class="n">width_ratios</span><span class="p">)</span>
            <span class="n">width_ratios</span> <span class="o">=</span> <span class="n">width_ratios</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
                <span class="n">df_pixel_all_max</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="mi">20</span><span class="p">})</span>
            <span class="n">ROI_label_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="n">ROI_info</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">ROI_info</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">ROI_size_divisor</span>

            <span class="k">for</span> <span class="n">analyte</span><span class="p">,</span> <span class="n">im</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">insitu_image</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]):</span>
                <span class="n">q_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">quantile</span><span class="p">)</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">im</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">q_max</span><span class="p">)</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;dark_background&#39;</span><span class="p">)</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
                <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span>
                    <span class="n">ROI_info</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="n">width_ratios</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">],</span> <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">ax_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ROI_info</span><span class="p">)):</span>
                    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax_index</span><span class="p">])</span>
                    <span class="n">ROI</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ROI_info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ax_index</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
                    <span class="n">start_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ROI</span><span class="o">.</span><span class="n">columns</span> <span class="o">==</span> <span class="s2">&quot;bottom&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">truncate_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ROI_info</span><span class="o">.</span><span class="n">columns</span> <span class="o">==</span> <span class="s2">&quot;right&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">squares</span> <span class="o">=</span> <span class="n">ROI</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">start_col</span><span class="p">:</span><span class="n">truncate_col</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

                    <span class="n">im_ROI</span> <span class="o">=</span> <span class="n">im</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">squares</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]):(</span><span class="nb">int</span><span class="p">(</span><span class="n">squares</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
                                <span class="nb">int</span><span class="p">(</span><span class="n">squares</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]):(</span><span class="nb">int</span><span class="p">(</span><span class="n">squares</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im_ROI</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">color_scheme</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">square</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">squares</span><span class="p">):</span>
                        <span class="n">bottom</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="n">square</span>
                        <span class="n">top</span> <span class="o">-=</span> <span class="n">bottom</span>
                        <span class="n">bottom</span> <span class="o">-=</span> <span class="n">bottom</span>
                        <span class="n">right</span> <span class="o">-=</span> <span class="n">left</span>
                        <span class="n">left</span> <span class="o">-=</span> <span class="n">left</span>
                        <span class="n">x_coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">left</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">left</span><span class="p">]</span>
                        <span class="n">y_coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">bottom</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">bottom</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">show_square</span><span class="p">:</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_coords</span><span class="p">,</span> <span class="n">y_coords</span><span class="p">,</span> <span class="s1">&#39;g-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">show_ROI</span><span class="p">:</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">right</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">bottom</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ROI</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                     <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">ROI_label_size</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>

                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

                <span class="n">cax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean image of cluster </span><span class="se">\n</span><span class="s2">&quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">analyte</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">ROI_label_size</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
                <span class="n">scalar_mappable</span> <span class="o">=</span> <span class="n">ScalarMappable</span><span class="p">(</span><span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">color_scheme</span><span class="p">)</span>
                <span class="n">scalar_mappable</span><span class="o">.</span><span class="n">set_clim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">colorbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span>
                    <span class="n">scalar_mappable</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
                <span class="n">colorbar</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">colorbar</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">quantile</span><span class="p">])</span>
                <span class="n">cax</span><span class="o">.</span><span class="n">set_position</span><span class="p">([</span><span class="n">cax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">x0</span><span class="p">,</span> <span class="n">cax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">y0</span> <span class="o">+</span> <span class="n">cax</span><span class="o">.</span><span class="n">get_position</span><span class="p">(</span>
                <span class="p">)</span><span class="o">.</span><span class="n">height</span> <span class="o">*</span> <span class="mf">0.25</span><span class="p">,</span> <span class="n">cax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">cax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">height</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">])</span>
                <span class="n">cax_pos</span> <span class="o">=</span> <span class="n">cax</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span>
                <span class="n">line_y</span> <span class="o">=</span> <span class="n">cax_pos</span><span class="o">.</span><span class="n">y1</span> <span class="o">+</span> <span class="mf">0.05</span>
                <span class="n">line_x_start</span> <span class="o">=</span> <span class="n">cax_pos</span><span class="o">.</span><span class="n">x0</span>
                <span class="n">line_x_end</span> <span class="o">=</span> <span class="n">cax_pos</span><span class="o">.</span><span class="n">x1</span>

                <span class="n">line</span> <span class="o">=</span> <span class="n">Line2D</span><span class="p">([</span><span class="n">line_x_start</span><span class="p">,</span> <span class="n">line_x_end</span><span class="p">],</span> <span class="p">[</span><span class="n">line_y</span><span class="p">,</span> <span class="n">line_y</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span>
                              <span class="n">transform</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">transFigure</span><span class="p">,</span> <span class="n">clip_on</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">ROI_linewidth</span><span class="p">)</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">add_artist</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">resolution_plt</span> <span class="o">=</span> <span class="n">resolution</span> <span class="o">*</span> \
                    <span class="nb">max</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ROI_info</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">ROI_info</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">line_x_end</span><span class="o">-</span><span class="n">line_x_start</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">ROI_num</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="n">line_x_start</span> <span class="o">+</span> <span class="n">line_x_end</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">line_y</span> <span class="o">+</span> <span class="mf">0.02</span><span class="p">,</span>
                         <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">resolution_plt</span><span class="si">:</span><span class="s1"> .0f</span><span class="si">}</span><span class="s1"> $\mu$m&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">ROI_label_size</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/image_cluster/mean_image_cluster</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">analyte</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">insitu_tsne</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;3D t-SNE not supported on GPU. CPU computing time may be long.&quot;</span><span class="p">)</span>
            <span class="n">truncate_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">columns</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span>
                <span class="mi">0</span><span class="p">)</span>
            <span class="n">df_pixel_all_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">df_pixel_all_max</span> <span class="o">=</span> <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_pixel_all_max</span><span class="p">[</span><span class="s2">&quot;ROI&quot;</span><span class="p">]</span>
                                                    <span class="o">!=</span> <span class="s2">&quot;placeholder&quot;</span><span class="p">]</span>
            <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">div</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>
            <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">div</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
            <span class="p">)</span>
            <span class="n">df_pixel_all_max</span> <span class="o">=</span> <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="kn">from</span> <span class="nn">sklearn.manifold</span> <span class="kn">import</span> <span class="n">TSNE</span>
            <span class="n">num_iters</span> <span class="o">=</span> <span class="mi">1000</span>
            <span class="n">my_random_state</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">cluster_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">truncate_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">columns</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">tsne_3d</span> <span class="o">=</span> <span class="n">TSNE</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="n">num_iters</span><span class="p">,</span>
                                   <span class="n">perplexity</span><span class="o">=</span><span class="n">insitu_perplexity</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">my_random_state</span><span class="p">)</span>
                    <span class="n">tsne_embedding_3d</span> <span class="o">=</span> <span class="n">tsne_3d</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span>
                        <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">kmeans_labels</span> <span class="o">==</span> <span class="n">cluster_index</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">tsne_3d</span> <span class="o">=</span> <span class="n">TSNE</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="n">num_iters</span><span class="p">,</span>
                                       <span class="n">perplexity</span><span class="o">=</span><span class="n">insitu_perplexity</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">my_random_state</span><span class="p">)</span>
                        <span class="n">tsne_embedding_3d</span> <span class="o">=</span> <span class="n">tsne_3d</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span>
                            <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">kmeans_labels</span> <span class="o">==</span> <span class="n">cluster_index</span><span class="p">])</span>
                        <span class="n">tsne_embedding_3d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">tsne_embedding_3d</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tsne_embedding_3d</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))))</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="n">tsne_3d</span> <span class="o">=</span> <span class="n">TSNE</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_iter</span><span class="o">=</span><span class="n">num_iters</span><span class="p">,</span>
                                       <span class="n">perplexity</span><span class="o">=</span><span class="n">insitu_perplexity</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="n">my_random_state</span><span class="p">)</span>
                        <span class="n">tsne_embedding_3d</span> <span class="o">=</span> <span class="n">tsne_3d</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span>
                            <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">kmeans_labels</span> <span class="o">==</span> <span class="n">cluster_index</span><span class="p">])</span>
                        <span class="n">tsne_embedding_3d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">(</span>
                            <span class="p">(</span><span class="n">tsne_embedding_3d</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">tsne_embedding_3d</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">tsne_embedding_3d</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span>

                <span class="n">rgb_tsne</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_pixel_all_max</span><span class="p">[</span><span class="s1">&#39;replicate&#39;</span><span class="p">],</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">tsne_embedding_3d</span><span class="p">),</span>
                                      <span class="n">df_pixel_all_max</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">rgb_tsne</span> <span class="o">=</span> <span class="n">rgb_tsne</span><span class="p">[</span><span class="n">rgb_tsne</span><span class="p">[</span><span class="s1">&#39;replicate&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">replicate</span><span class="p">]</span>
                <span class="n">rgb_tsne</span> <span class="o">=</span> <span class="n">rgb_tsne</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;replicate&#39;</span><span class="p">])</span>
                <span class="n">rgb_tsne</span> <span class="o">=</span> <span class="n">rgb_tsne</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

                <span class="n">img_array_1c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">rgb_tsne</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">rgb_tsne</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]))</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                                         <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">rgb_tsne</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">2</span><span class="p">]))</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">insitu_image</span> <span class="o">=</span> <span class="n">make_image_1c_njit</span><span class="p">(</span>
                    <span class="n">data_2darray</span><span class="o">=</span><span class="n">rgb_tsne</span><span class="p">,</span> <span class="n">img_array_1c</span><span class="o">=</span><span class="n">img_array_1c</span><span class="p">,</span> <span class="n">remap_coord</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">insitu_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_equal</span><span class="p">(</span><span class="n">insitu_image</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">norm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">insitu_image</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
                                 <span class="n">vmax</span><span class="o">=</span><span class="n">insitu_image</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
                <span class="n">insitu_image</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">insitu_image</span><span class="p">)</span>
                <span class="n">insitu_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">insitu_image</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">insitu_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span>
                    <span class="n">insitu_image</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="n">width_ratios</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">ROI_info</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">ROI_info</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="n">width_ratios</span> <span class="o">/=</span> <span class="nb">max</span><span class="p">(</span><span class="n">width_ratios</span><span class="p">)</span>

                <span class="n">width_ratios</span> <span class="o">=</span> <span class="n">width_ratios</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;dark_background&#39;</span><span class="p">)</span>
                <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
                <span class="n">gs</span> <span class="o">=</span> <span class="n">GridSpec</span><span class="p">(</span>
                    <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ROI_info</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">width_ratios</span><span class="o">=</span><span class="n">width_ratios</span> <span class="o">+</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">],</span> <span class="n">figure</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
                <span class="n">ROI_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ROI_info</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ROI_info</span><span class="p">[</span><span class="s2">&quot;replicate&quot;</span><span class="p">]</span>
                                         <span class="o">==</span> <span class="n">replicate</span><span class="p">]</span>
                <span class="n">ROI_info</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
                    <span class="n">df_pixel_all_max</span><span class="p">[[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="mi">20</span><span class="p">})</span>
                <span class="n">ROI_label_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                    <span class="n">ROI_info</span><span class="p">[</span><span class="s1">&#39;right&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">ROI_info</span><span class="p">[</span><span class="s1">&#39;left&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">ROI_size_divisor</span>
                <span class="k">for</span> <span class="n">ax_index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ROI_info</span><span class="p">)):</span>
                    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax_index</span><span class="p">])</span>
                    <span class="n">ROI</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">ROI_info</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ax_index</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
                    <span class="n">start_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ROI</span><span class="o">.</span><span class="n">columns</span> <span class="o">==</span> <span class="s2">&quot;bottom&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">truncate_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ROI_info</span><span class="o">.</span><span class="n">columns</span> <span class="o">==</span> <span class="s2">&quot;right&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">squares</span> <span class="o">=</span> <span class="n">ROI</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">start_col</span><span class="p">:</span><span class="n">truncate_col</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

                    <span class="n">im_ROI</span> <span class="o">=</span> <span class="n">insitu_image</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">squares</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]):(</span><span class="nb">int</span><span class="p">(</span><span class="n">squares</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span>
                                          <span class="nb">int</span><span class="p">(</span><span class="n">squares</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]):(</span><span class="nb">int</span><span class="p">(</span><span class="n">squares</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">3</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">im_ROI</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">square</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">squares</span><span class="p">):</span>
                        <span class="n">bottom</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="n">square</span>
                        <span class="n">top</span> <span class="o">-=</span> <span class="n">bottom</span>
                        <span class="n">bottom</span> <span class="o">-=</span> <span class="n">bottom</span>
                        <span class="n">right</span> <span class="o">-=</span> <span class="n">left</span>
                        <span class="n">left</span> <span class="o">-=</span> <span class="n">left</span>
                        <span class="n">x_coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">left</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">left</span><span class="p">]</span>
                        <span class="n">y_coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">bottom</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">bottom</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">show_square</span><span class="p">:</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_coords</span><span class="p">,</span> <span class="n">y_coords</span><span class="p">,</span> <span class="s1">&#39;g-&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">show_ROI</span><span class="p">:</span>
                            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">right</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">bottom</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ROI</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                     <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">ROI_label_size</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>

                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/image_cluster/insitu_3D_tsne_cluster</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cluster_index</span><span class="si">}</span><span class="s2">.png&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="DataAnalysis.optimize_image_clustering">
<a class="viewcode-back" href="../../iMSminer.html#iMSminer.data_analysis.DataAnalysis.optimize_image_clustering">[docs]</a>
    <span class="k">def</span> <span class="nf">optimize_image_clustering</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">k_max</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Group ion images by spatial co-localization. Outputs in situ and box plot visualizations of mean ion image for each cluster. Clustering analysis and in situ mapping of clusters are summarized in lower-dimensional t -SNE embedding.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        k_max : int, optional</span>
<span class="sd">            Maximum number of clusters for cluster validity evaluation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/image_cluster&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/image_cluster&quot;</span><span class="p">)</span>

        <span class="n">score_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">k_max</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

        <span class="n">truncate_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">columns</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">)</span>
        <span class="n">df_pixel_all_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">df_pixel_all_max</span> <span class="o">=</span> <span class="n">df_pixel_all_max</span><span class="p">[</span><span class="n">df_pixel_all_max</span><span class="p">[</span><span class="s2">&quot;ROI&quot;</span><span class="p">]</span>
                                            <span class="o">!=</span> <span class="s2">&quot;placeholder&quot;</span><span class="p">]</span>
        <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">div</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

        <span class="n">num_iters</span> <span class="o">=</span> <span class="mi">1000</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">k_max</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpu</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Image clustering on CPU. Computing time may be long.&quot;</span><span class="p">)</span>
                <span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span>
                <span class="n">k_means</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="s2">&quot;k-means++&quot;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                 <span class="n">n_init</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="n">num_iters</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                <span class="n">kmeans_labels</span> <span class="o">=</span> <span class="n">k_means</span><span class="o">.</span><span class="n">labels_</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpu</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Image clustering on GPU.&quot;</span><span class="p">)</span>
                    <span class="kn">from</span> <span class="nn">cuml</span> <span class="kn">import</span> <span class="n">using_output_type</span>
                    <span class="kn">from</span> <span class="nn">cuml.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span>

                    <span class="k">with</span> <span class="n">using_output_type</span><span class="p">(</span><span class="s1">&#39;numpy&#39;</span><span class="p">):</span>

                        <span class="n">k_means</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="n">num_iters</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
                            <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                        <span class="n">kmeans_labels</span> <span class="o">=</span> <span class="n">k_means</span><span class="o">.</span><span class="n">labels_</span> <span class="o">+</span> <span class="mi">1</span>

                <span class="k">except</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;GPU error. Defaulting to CPU.&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Image clustering on CPU. Computing time may be long.&quot;</span><span class="p">)</span>
                    <span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span>

                    <span class="n">k_means</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="s2">&quot;k-means++&quot;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                     <span class="n">n_init</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="n">num_iters</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
                    <span class="n">kmeans_labels</span> <span class="o">=</span> <span class="n">k_means</span><span class="o">.</span><span class="n">labels_</span> <span class="o">+</span> <span class="mi">1</span>

                <span class="n">score_array</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">davies_bouldin_score</span><span class="p">(</span>
                    <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">kmeans_labels</span><span class="p">)</span>
                <span class="n">score_array</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">calinski_harabasz_score</span><span class="p">(</span>
                    <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">kmeans_labels</span><span class="p">)</span>
                <span class="n">score_array</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">silhouette_score</span><span class="p">(</span><span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">k_means</span><span class="o">.</span><span class="n">fit_predict</span><span class="p">(</span>
                    <span class="n">df_pixel_all_max</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="n">truncate_col</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
                <span class="n">score_array</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">k_means</span><span class="o">.</span><span class="n">inertia_</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>
        <span class="n">categories</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;DB&quot;</span><span class="p">,</span> <span class="s2">&quot;CH&quot;</span><span class="p">,</span> <span class="s2">&quot;Silhouette&quot;</span><span class="p">,</span> <span class="s2">&quot;Elbow&quot;</span><span class="p">]</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="mi">22</span><span class="p">})</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="s2">&quot;black&quot;</span><span class="p">]</span>
        <span class="n">normalized_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">score_array</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">score_array</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">x_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">k_max</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">category</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">categories</span><span class="p">,</span> <span class="n">colors</span><span class="p">)):</span>
            <span class="n">y_values</span> <span class="o">=</span> <span class="n">normalized_scores</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="n">y_values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">category</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="n">y_values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Number of clusters&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Max-Normalized Scores&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Score&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;small&quot;</span><span class="p">,</span>
                   <span class="n">title_fontproperties</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;weight&#39;</span><span class="p">:</span> <span class="s1">&#39;bold&#39;</span><span class="p">})</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/image_cluster/image_clustering_optimization_plot.png&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="DataAnalysis.make_boxplot">
<a class="viewcode-back" href="../../iMSminer.html#iMSminer.data_analysis.DataAnalysis.make_boxplot">[docs]</a>
    <span class="k">def</span> <span class="nf">make_boxplot</span><span class="p">(</span>
            <span class="bp">self</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Box plot comparison of mean ion intensity across ROIs with pairwise statistical comparison. Statistical significance thresholds are represented as `*` if 0.05 &gt; $p$-value $geq$ 0.01, `**` if 0.01 &gt; $p$-value $geq$ 0.001, and `***` if $p$-value $\leq$ 0.001.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/boxplot&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/boxplot&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df_mean_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_pixel_all</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span>
            <span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">,</span> <span class="s1">&#39;replicate&#39;</span><span class="p">,</span> <span class="s1">&#39;ROI_num&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_mean_all</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_mean_all</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_mean_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_mean_all</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">df_mean_all</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">]</span>
                                            <span class="o">!=</span> <span class="s1">&#39;placeholder&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_mean_all</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Needs at least 2 ROIs.&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">ROI</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_mean_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">df_mean_all_long</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_mean_all</span><span class="p">,</span> <span class="n">id_vars</span><span class="o">=</span><span class="p">[</span>
                                   <span class="s1">&#39;ROI&#39;</span><span class="p">,</span> <span class="s1">&#39;replicate&#39;</span><span class="p">,</span> <span class="s1">&#39;ROI_num&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;analyte&#39;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;intensity&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">analyte</span> <span class="ow">in</span> <span class="n">df_mean_all_long</span><span class="p">[</span><span class="s1">&#39;analyte&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="n">df_mean_all_analyte</span> <span class="o">=</span> <span class="n">df_mean_all_long</span><span class="p">[</span><span class="n">df_mean_all_long</span><span class="p">[</span><span class="s1">&#39;analyte&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">analyte</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">df_resid</span> <span class="o">=</span> <span class="n">ols</span><span class="p">(</span><span class="s1">&#39;intensity ~ C(ROI)&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df_mean_all_analyte</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="p">(</span><span class="n">df_mean_all_analyte</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">df_mean_all_analyte</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span> <span class="o">|</span>
                    <span class="p">(</span><span class="n">df_mean_all_analyte</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">]</span> <span class="o">==</span>
                     <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">df_mean_all_analyte</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">])[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">,</span> <span class="s1">&#39;intensity&#39;</span><span class="p">]]</span>
                <span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span><span class="o">.</span><span class="n">df_resid</span>
                <span class="k">if</span> <span class="n">df_resid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="s2">&quot;Insufficient sample size for computing p-values.&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">None</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;Insufficient sample size for computing p-values.&quot;</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="n">pvalue</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">sm</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">anova_lm</span><span class="p">(</span>
                    <span class="n">ols</span><span class="p">(</span><span class="s1">&#39;intensity ~ C(ROI)&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df_mean_all_analyte</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                        <span class="p">(</span><span class="n">df_mean_all_analyte</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">combo</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">|</span>
                        <span class="p">(</span><span class="n">df_mean_all_analyte</span><span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">combo</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                        <span class="p">[</span><span class="s1">&#39;ROI&#39;</span><span class="p">,</span> <span class="s1">&#39;intensity&#39;</span><span class="p">]]</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(),</span>
                    <span class="n">typ</span><span class="o">=</span><span class="mi">1</span>
                <span class="p">)[</span><span class="s1">&#39;PR(&gt;F)&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">for</span> <span class="n">combo</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">combinations</span><span class="p">(</span><span class="n">ROI</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="mi">2</span><span class="p">))</span>
            <span class="p">]</span>
            <span class="n">model_pairs</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">combo</span>
                <span class="k">for</span> <span class="n">combo</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">combinations</span><span class="p">(</span><span class="n">ROI</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="mi">2</span><span class="p">))</span>
            <span class="p">]</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;default&#39;</span><span class="p">)</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span>
                <span class="p">(</span><span class="mi">10</span><span class="o">+</span><span class="n">math</span><span class="o">.</span><span class="n">comb</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ROI_num</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="mi">7</span><span class="o">+</span><span class="n">math</span><span class="o">.</span><span class="n">comb</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ROI_num</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;font.size&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">7</span><span class="o">+</span><span class="n">math</span><span class="o">.</span><span class="n">comb</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ROI_num</span><span class="p">,</span> <span class="mi">2</span><span class="p">))})</span>

            <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;ROI&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;intensity&quot;</span><span class="p">,</span>
                        <span class="n">data</span><span class="o">=</span><span class="n">df_mean_all_analyte</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">stripplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;ROI&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;intensity&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df_mean_all_analyte</span><span class="p">,</span>
                          <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">jitter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">annotator</span> <span class="o">=</span> <span class="n">Annotator</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">model_pairs</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;ROI&quot;</span><span class="p">,</span>
                                  <span class="n">y</span><span class="o">=</span><span class="s2">&quot;intensity&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">df_mean_all_analyte</span><span class="p">)</span>
            <span class="n">formatted_pvalues</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">significance</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">pvalue</span><span class="p">]</span>
            <span class="n">annotator</span><span class="o">.</span><span class="n">set_custom_annotations</span><span class="p">(</span><span class="n">formatted_pvalues</span><span class="p">)</span>
            <span class="n">annotator</span><span class="o">.</span><span class="n">annotate</span><span class="p">()</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;m/z </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">analyte</span><span class="p">)]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;ROI&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Mean Intensity&#39;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;bold&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">/figures/boxplot/mz_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mz</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">analyte</span><span class="p">)]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">.jpg&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Yu Tin Lin.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>